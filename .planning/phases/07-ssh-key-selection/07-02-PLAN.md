---
phase: 07-ssh-key-selection
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/tui/key_picker.go
  - internal/tui/form.go
  - internal/tui/detail_view.go
  - internal/tui/model.go
  - internal/tui/keys.go
  - internal/tui/messages.go
  - internal/tui/styles.go
autonomous: false
must_haves:
  truths:
    - "User can open key picker from both add/edit form and detail view"
    - "Key picker shows unified flat list with source badges ([file], [agent], [1password])"
    - "Currently-assigned key is highlighted with checkmark in picker"
    - "'None (SSH default)' is the first option in picker to clear key assignment"
    - "Selected key persists as IdentityFile in SSH config when form saves"
    - "Missing keys (referenced but not on disk) show warning badge in picker"
    - "Key picker renders as overlay (like ProjectPicker) without blocking TUI event loop"
    - "Detail view shows key info with filename, type, fingerprint, and source badge"
    - "Existing IdentityFile directives are pre-selected when editing a connection"
  artifacts:
    - path: "internal/tui/key_picker.go"
      provides: "SSHKeyPicker overlay component adapted from ProjectPicker pattern"
      exports: ["SSHKeyPicker", "NewSSHKeyPicker"]
    - path: "internal/tui/form.go"
      provides: "Modified form with key picker field replacing text input for IdentityFile"
      contains: "keyPicker"
    - path: "internal/tui/detail_view.go"
      provides: "Key info display with source badge in detail view"
      contains: "SourceBadge"
    - path: "internal/tui/model.go"
      provides: "Key picker message routing, async key discovery on Init"
      contains: "keyPickerClosedMsg"
    - path: "internal/tui/keys.go"
      provides: "SelectKey keybinding for detail view quick action"
      contains: "SelectKey"
    - path: "internal/tui/messages.go"
      provides: "Key picker message types"
      contains: "keySelectedMsg"
    - path: "internal/tui/styles.go"
      provides: "Source badge styles for key picker"
      contains: "keySourceBadgeStyle"
  key_links:
    - from: "internal/tui/key_picker.go"
      to: "internal/sshkey/types.go"
      via: "SSHKey type used for picker items"
      pattern: "sshkey\\.SSHKey"
    - from: "internal/tui/model.go"
      to: "internal/sshkey/discovery.go"
      via: "DiscoverKeys called async on Init"
      pattern: "sshkey\\.DiscoverKeys"
    - from: "internal/tui/form.go"
      to: "internal/tui/key_picker.go"
      via: "Form opens key picker on IdentityFile field action"
      pattern: "NewSSHKeyPicker"
    - from: "internal/tui/form.go"
      to: "internal/sshconfig/writer.go"
      via: "HostEntry.IdentityFile set from selected key path"
      pattern: "IdentityFile.*selectedKey"
---

<objective>
Build the SSH Key Picker TUI overlay and integrate it into the existing add/edit form and detail view so users can select which SSH key to use per connection.

Purpose: This plan delivers the complete user-facing feature. Users will be able to discover, browse, and select SSH keys from a unified picker that appears both in the form (when editing IdentityFile) and as a quick action from the detail view.
Output: Working key picker overlay, modified form with picker integration, detail view showing key info, keybinding for quick key selection.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ssh-key-selection/07-01-SUMMARY.md
@internal/tui/picker.go
@internal/tui/form.go
@internal/tui/detail_view.go
@internal/tui/model.go
@internal/tui/keys.go
@internal/tui/messages.go
@internal/tui/styles.go
@internal/sshconfig/writer.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: SSHKeyPicker overlay component and TUI wiring</name>
  <files>
    internal/tui/key_picker.go
    internal/tui/messages.go
    internal/tui/styles.go
    internal/tui/model.go
    internal/tui/keys.go
  </files>
  <action>
    Create `internal/tui/key_picker.go` — a new overlay component adapted from the existing ProjectPicker pattern in `picker.go`. The key picker is a centered overlay that lists all discovered SSH keys.

    **SSHKeyPicker struct:**
    - `keys []sshkey.SSHKey` — discovered keys
    - `selected int` — cursor position
    - `currentKeyPath string` — currently assigned IdentityFile path (for checkmark)
    - `width int`, `height int` — overlay dimensions
    - `serverName string` — which server this is for (displayed in title)

    **Rendering (adapt from ProjectPicker.View):**
    - Title: "Select SSH Key: {serverName}" using pickerTitleStyle
    - First item always: "None (SSH default)" — selecting this clears IdentityFile
    - For each key, render one line with:
      - Cursor indicator: `> ` if selected, `  ` otherwise
      - Checkmark: `checkmark ` if key.Path matches currentKeyPath, `  ` otherwise
      - Key info: `{filename} {type} {source_badge}` on first column
      - Below or inline: fingerprint in secondary style (truncated to fit width)
      - If key.Missing: show warning badge `[missing]` in warningStyle
      - If key.Encrypted: show `[encrypted]` badge in secondaryStyle
      - Source badge: `[file]`, `[agent]`, `[1password]` — use new keySourceFileStyle (green-ish), keySourceAgentStyle (blue-ish), keySource1PStyle (purple-ish) respectively
    - Help text at bottom: "up/k down/j: navigate | enter: select | esc: cancel"
    - Wrap in pickerBorderStyle (reuse existing)

    **Update method (adapt from ProjectPicker.Update):**
    - `esc` → send `keyPickerClosedMsg{}`
    - `j`/`down` → move cursor down (clamp to len(keys))
    - `k`/`up` → move cursor up (clamp to 0)
    - `enter` → if "None" selected: send `keySelectedMsg{path: "", cleared: true}`, otherwise send `keySelectedMsg{path: key.Path, key: key}` with the selected SSHKey

    **New message types in messages.go:**
    - `keyPickerClosedMsg struct{}` — picker cancelled
    - `keySelectedMsg struct { path string; key *sshkey.SSHKey; cleared bool }` — key chosen (cleared=true means "None")
    - `keysDiscoveredMsg struct { keys []sshkey.SSHKey; err error }` — async discovery result

    **New styles in styles.go:**
    - `keySourceFileStyle` — green-ish AdaptiveColor badge
    - `keySourceAgentStyle` — blue-ish AdaptiveColor badge
    - `keySource1PStyle` — purple-ish AdaptiveColor badge
    - `keyMissingBadgeStyle` — use existing warningStyle
    - `keyEncryptedBadgeStyle` — secondaryColor + italic
    - `keyFingerprintStyle` — secondaryColor, smaller/dimmer

    **Model changes in model.go:**
    - Add field: `discoveredKeys []sshkey.SSHKey` — populated on Init async
    - Add field: `keyPicker *SSHKeyPicker` — nil when not showing
    - Add field: `showingKeyPicker bool`
    - In `Init()`: add `discoverKeysCmd()` that calls `sshkey.DiscoverKeys("~/.ssh/", servers)` async, returns `keysDiscoveredMsg`
    - In `Update()`:
      - Handle `keysDiscoveredMsg`: store keys in `m.discoveredKeys`
      - Route key events to keyPicker when `m.showingKeyPicker` is true (BEFORE view-specific handling, same pattern as showingPicker for projects — add right after the project picker routing block at line ~734)
      - Handle `keyPickerClosedMsg`: set `m.showingKeyPicker = false`, `m.keyPicker = nil`
      - Handle `keySelectedMsg`: update the form's IdentityFile field if in form view, or update server config if in detail view; close picker
    - In `View()`: when `showingKeyPicker`, render centered overlay (same lipgloss.Place pattern as project picker)

    **Keybinding in keys.go:**
    - Add `SelectKey key.Binding` to KeyMap struct with key "K" (capital K), help text "K: key"
    - Add to ShortHelp and FullHelp slices
    - In DefaultKeyMap: `key.NewBinding(key.WithKeys("K"), key.WithHelp("K", "ssh key"))`

    **Detail view quick action in model.go Update (ViewDetail case):**
    - When user presses "K" in detail view:
      - Create SSHKeyPicker with discoveredKeys and current host's IdentityFile
      - Set showingKeyPicker = true
      - On keySelectedMsg from detail view context:
        - Update the host's SSH config IdentityFile using sshconfig.EditHost
        - Refresh the detail view content
        - Show status message "Key updated: {filename}" or "Key cleared (using SSH default)"
  </action>
  <verify>
    1. `go build ./internal/tui/...` compiles without errors
    2. `go vet ./internal/tui/...` no issues
    3. Manual check: Key picker struct matches ProjectPicker pattern
  </verify>
  <done>
    SSHKeyPicker component exists with Update/View methods. Model routes keysDiscoveredMsg, keyPickerClosedMsg, keySelectedMsg. "K" keybinding registered. Async key discovery fires on Init. Key picker can be opened from detail view.
  </done>
</task>

<task type="auto">
  <name>Task 2: Form integration and IdentityFile persistence</name>
  <files>
    internal/tui/form.go
    internal/tui/detail_view.go
    internal/tui/model.go
  </files>
  <action>
    **Form modification (form.go):**

    Replace the IdentityFile text input field (fields[4]) with a "button-like" field that opens the key picker:
    - Keep fields[4] as a textinput.Model for display purposes, but make it read-only (show selected key path or "None (SSH default)")
    - Add field `selectedKey *sshkey.SSHKey` to ServerForm struct — tracks selected key (nil = None)
    - When the user focuses the IdentityFile field (index 4) and presses Enter or Space:
      - Instead of typing, send a message to open the key picker
      - The parent Model handles this by creating and showing the SSHKeyPicker overlay
    - When `keySelectedMsg` arrives back at the form:
      - If `cleared`: set fields[4].input value to "" (empty), set selectedKey to nil
      - Otherwise: set fields[4].input value to key.Path, set selectedKey to &key
    - The field should display the key info nicely:
      - If a key is selected: show `{path} ({type}) {source_badge}`
      - If None: show "None (SSH default)" in placeholder style
    - In `performSave()` / `performBackendSave()`: the IdentityFile field value (fields[4].input.Value()) already flows into HostEntry.IdentityFile or domain.Server.IdentityFile — this works without changes since we're setting the input value

    **Add a new message type for form-to-model communication:**
    - `formRequestKeyPickerMsg struct{ currentKeyPath string }` — form asks model to open key picker
    - In model.go Update, when in ViewAdd/ViewEdit and receiving this message:
      - Create SSHKeyPicker with m.discoveredKeys and the currentKeyPath from message
      - Set showingKeyPicker = true
    - When keySelectedMsg received while in ViewAdd/ViewEdit:
      - Forward to form via a new method: `form.SetSelectedKey(key)`
      - Close picker

    **Pre-selection for edit mode (form.go NewEditServerForm):**
    - If host.IdentityFile has values, pre-fill fields[4] with first IdentityFile path
    - In model.go, when opening edit form: try to find matching SSHKey in discoveredKeys by path
      - If found: set form.selectedKey to that key
      - If NOT found but IdentityFile is set: create a "missing" key entry (sshkey.CreateMissingKeyEntry) and set it
    - This enables the picker to show the checkmark on the correct key

    **Detail view enhancement (detail_view.go):**
    - In `renderDetailView()`, enhance the IdentityFile section:
      - Instead of just listing file paths, show richer key info if discoveredKeys are available
      - Add a new parameter `discoveredKeys []sshkey.SSHKey` to renderDetailView (or pass via the Model)
      - For each IdentityFile path in host.IdentityFile:
        - Try to find matching key in discoveredKeys by path
        - If found: display `{path} ({type}) {source_badge} — {fingerprint_truncated}`
        - If not found on disk: display `{path} [missing]` in warningStyle
        - If found but no match in discovered keys: display path only (fallback)
    - Add help text in detail view footer: include "K: select key" alongside existing bindings

    **Model.go wiring adjustments:**
    - Update renderDetailView calls to pass discoveredKeys (may need to change the function signature or use a method on Model instead)
    - In the ViewDetail esc handler: if showingKeyPicker, close picker instead of going back to list
    - When keySelectedMsg received in ViewDetail context:
      - Determine the host being viewed (m.detailHost)
      - Call sshconfig.EditHost to update the IdentityFile directive
      - Or if backend server: call backend.UpdateServer
      - Refresh detail view content and host list
      - Show status message
    - When keySelectedMsg received in ViewAdd/ViewEdit context:
      - Update the form's IdentityFile field and selectedKey
      - Close picker, return focus to form

    Important: Do NOT set IdentitiesOnly when writing IdentityFile — per user decision, let SSH try other keys from agent too. Single key per connection only (fields[4] holds one path, not a list).
  </action>
  <verify>
    1. `go build ./...` — entire project compiles
    2. `go vet ./...` — no issues
    3. `go test ./...` — all existing tests still pass (no regressions)
  </verify>
  <done>
    Form shows key picker when IdentityFile field is activated. Key selection updates the field value. Edit form pre-selects existing IdentityFile. Detail view shows enriched key info with type and source badges. Saving persists IdentityFile to SSH config. "K" in detail view opens picker and updates config on selection.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify SSH key selection end-to-end</name>
  <what-built>
    Complete SSH key selection feature: key discovery from filesystem/agent/1Password, key picker overlay, form integration, detail view display, and IdentityFile persistence.
  </what-built>
  <how-to-verify>
    1. **Launch ssherpa**: Run `go run ./cmd/ssherpa/`
    2. **Check key discovery**: Keys should be discovered on startup (no visible indicator needed, but picker should be populated)

    3. **Test from detail view (quick action)**:
       a. Select any server, press Tab/i to open detail view
       b. Press "K" (capital) to open key picker
       c. Verify: picker shows "None (SSH default)" at top, then your SSH keys with source badges
       d. Verify: each key shows filename, type (ed25519/rsa), and source badge ([file], [agent], etc.)
       e. Select a key with Enter
       f. Verify: detail view updates to show selected key
       g. Press Esc to go back to list

    4. **Test from add form**:
       a. Press "a" to add new server
       b. Fill in Alias, Hostname, User
       c. Navigate to IdentityFile field (Tab to field 5)
       d. Press Enter or Space to open key picker
       e. Select a key
       f. Verify: IdentityFile field shows the selected key path
       g. Save the form (Ctrl+S)
       h. Verify: new entry in ~/.ssh/config has IdentityFile directive

    5. **Test from edit form**:
       a. Select a server that has an IdentityFile set
       b. Press "e" to edit
       c. Verify: IdentityFile field shows the existing key path
       d. Navigate to IdentityFile, press Enter
       e. Verify: picker shows checkmark on the currently-assigned key
       f. Select "None (SSH default)" to clear
       g. Save and verify IdentityFile directive is removed

    6. **Test edge cases**:
       a. If SSH agent is running: verify agent keys show with [agent] badge
       b. Check that missing keys (referenced in config but not on disk) show [missing] warning
       c. Verify picker closes cleanly on Esc without changes
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `go build ./...` — entire project compiles
2. `go test ./...` — all tests pass (including new sshkey package tests from Plan 01)
3. `go vet ./...` — no vet issues
4. Key picker is accessible from both detail view (K) and form (Enter on IdentityFile field)
5. Key selection persists to SSH config as IdentityFile directive
6. Key picker shows all three sources with correct badges
7. "None (SSH default)" option works to clear key assignment
</verification>

<success_criteria>
- Key picker overlay renders correctly as centered overlay (like ProjectPicker)
- All discovered keys shown with filename, type, fingerprint, source badge
- "None (SSH default)" is first option and clears IdentityFile
- Currently-assigned key has checkmark in picker
- Form's IdentityFile field opens picker instead of text input
- Edit mode pre-selects existing IdentityFile
- Detail view shows enriched key info with source badges
- "K" keybinding opens picker from detail view
- Saving from form persists IdentityFile to SSH config correctly
- Missing keys show warning badge
- No TUI blocking — key discovery is async
</success_criteria>

<output>
After completion, create `.planning/phases/07-ssh-key-selection/07-02-SUMMARY.md`
</output>
