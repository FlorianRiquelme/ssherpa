---
phase: 03-connection-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/history/history.go
  - internal/history/history_test.go
  - internal/ssh/connect.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Connection history records are persisted to disk as JSON lines"
    - "Last-connected-for-path lookup returns correct entry by working directory"
    - "SSH command is constructed with correct host name and terminal I/O connected"
    - "History file is created with 0600 permissions if it does not exist"
    - "Malformed history lines are skipped without crashing"
  artifacts:
    - path: "internal/history/history.go"
      provides: "Connection history tracking (record, read, last-for-path)"
      exports: ["HistoryEntry", "RecordConnection", "GetLastConnectedForPath", "GetRecentHosts", "DefaultHistoryPath"]
    - path: "internal/history/history_test.go"
      provides: "History package tests"
      min_lines: 100
    - path: "internal/ssh/connect.go"
      provides: "SSH command construction and tea.Cmd wrapper"
      exports: ["SSHFinishedMsg", "ConnectSSH"]
  key_links:
    - from: "internal/history/history.go"
      to: "~/.ssh/ssherpa_history.json"
      via: "JSON append-only file I/O"
      pattern: "os\\.OpenFile.*O_APPEND"
    - from: "internal/ssh/connect.go"
      to: "os/exec"
      via: "exec.Command with terminal I/O"
      pattern: "cmd\\.Stdin = os\\.Stdin"
---

<objective>
Create the connection history tracking package and SSH connection helper that Phase 3's TUI changes will depend on.

Purpose: These two independent subsystems (history persistence and SSH handoff) form the foundation for the TUI's connect-and-track workflow. Building them first with tests ensures the TUI plan can focus purely on integration.

Output: `internal/history/` package with tested CRUD for JSON history file, `internal/ssh/connect.go` with tea.ExecProcess wrapper for SSH handoff.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-connection-navigation/03-RESEARCH.md

@internal/sshconfig/parser.go — SSHHost struct definition (used by history and SSH connect)
@internal/tui/model.go — Current TUI model (shows how tea.Cmd pattern is used)
@go.mod — Current dependencies (sahilm/fuzzy already indirect)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connection history package</name>
  <files>internal/history/history.go, internal/history/history_test.go</files>
  <action>
Create `internal/history/` package with JSON-lines append-only history file support.

**`internal/history/history.go`:**

1. Define `HistoryEntry` struct with fields:
   - `Timestamp time.Time` (json:"timestamp")
   - `WorkingDir string` (json:"working_dir") — cwd when connection was made
   - `HostName string` (json:"host_name") — SSH config Host alias (e.g., "myserver")
   - `Hostname string` (json:"hostname") — resolved hostname (e.g., "10.0.1.5")
   - `User string` (json:"user") — SSH user

2. `DefaultHistoryPath() string` — returns `~/.ssh/ssherpa_history.json` using `os.UserHomeDir()`. If home dir lookup fails, return empty string.

3. `RecordConnection(path, hostName, hostname, user string) error`:
   - Opens file at `path` with `os.O_CREATE|os.O_APPEND|os.O_WRONLY`, permissions `0600`
   - Gets `os.Getwd()` for WorkingDir (empty string fallback if error)
   - Creates `HistoryEntry` with `time.Now()` timestamp
   - Writes single JSON line via `json.NewEncoder(f).Encode(entry)`
   - Returns wrapped error on failure

4. `GetLastConnectedForPath(historyPath, workingDir string) (*HistoryEntry, error)`:
   - Opens history file for reading
   - Returns `(nil, nil)` if file doesn't exist (`os.IsNotExist`)
   - Reads all entries via `json.NewDecoder` in a loop, skipping malformed lines (continue on decode error, break on `io.EOF`)
   - Iterates backwards to find most recent entry where `WorkingDir == workingDir`
   - Returns `(*HistoryEntry, nil)` or `(nil, nil)` if no match

5. `GetRecentHosts(historyPath string, limit int) (map[string]time.Time, error)`:
   - Returns map of `hostName -> most recent timestamp` for the last `limit` unique hosts
   - Used by TUI to show last-connected indicator (star icon) next to recently-connected servers
   - Returns empty map (not error) if file doesn't exist

**`internal/history/history_test.go`:**

Write tests using testify and `t.TempDir()` for isolated file I/O:
- TestRecordConnection_CreatesFileAndWritesEntry
- TestRecordConnection_AppendsToExistingFile
- TestRecordConnection_FilePermissions (check 0600)
- TestGetLastConnectedForPath_NoFile (returns nil, nil)
- TestGetLastConnectedForPath_NoMatch (returns nil, nil)
- TestGetLastConnectedForPath_FindsMatch
- TestGetLastConnectedForPath_FindsMostRecent (multiple entries for same path, returns latest)
- TestGetLastConnectedForPath_SkipsMalformedLines
- TestGetRecentHosts_ReturnsUniqueHostsWithLatestTimestamp
- TestGetRecentHosts_NoFile (returns empty map)

Use `time.Now().Add(-1 * time.Hour)` etc. for timestamp ordering tests.
  </action>
  <verify>
Run `go test -race -v ./internal/history/` — all tests pass.
Run `go vet ./internal/history/` — no warnings.
  </verify>
  <done>
History package records connections as JSON lines, retrieves last-connected-for-path, and returns recent hosts map. All 10+ tests pass with race detector enabled. File permissions are 0600.
  </done>
</task>

<task type="auto">
  <name>Task 2: SSH connection helper</name>
  <files>internal/ssh/connect.go</files>
  <action>
Create `internal/ssh/` package with SSH command construction and Bubbletea integration.

**`internal/ssh/connect.go`:**

1. Define `SSHFinishedMsg` struct:
   - `Err error` — non-nil if SSH process failed (connection refused, auth failure, etc.)
   - `HostName string` — which host was connected to (for post-connection logic)

2. `ConnectSSH(hostName string) tea.Cmd`:
   - Constructs `exec.Command("ssh", hostName)` — uses SSH config alias so user's full SSH config (ProxyJump, IdentityFile, etc.) is leveraged automatically
   - CRITICAL: Sets `cmd.Stdin = os.Stdin`, `cmd.Stdout = os.Stdout`, `cmd.Stderr = os.Stderr` for silent terminal handoff
   - Returns `tea.ExecProcess(cmd, func(err error) tea.Msg { return SSHFinishedMsg{Err: err, HostName: hostName} })`

This is intentionally minimal — SSH config alias-based connection leverages the user's existing `~/.ssh/config` settings. No need to construct `-p`, `-i`, `-l` flags manually since `ssh hostname_alias` reads all options from config.

Import `tea "github.com/charmbracelet/bubbletea"`, `"os"`, `"os/exec"`.

Promote `sahilm/fuzzy` from indirect to direct dependency in go.mod by running `go get github.com/sahilm/fuzzy@latest` (needed by Plan 02's search functionality — do it here to keep Plan 02 focused on TUI).
  </action>
  <verify>
Run `go build ./internal/ssh/` — compiles cleanly.
Run `go vet ./internal/ssh/` — no warnings.
Run `go build ./...` — full project compiles.
  </verify>
  <done>
SSH connect helper provides `ConnectSSH(hostName)` returning a `tea.Cmd` that hands off terminal control to system SSH via `tea.ExecProcess`. `SSHFinishedMsg` carries error and host name for post-connection handling. `sahilm/fuzzy` promoted to direct dependency.
  </done>
</task>

</tasks>

<verification>
- `go test -race ./internal/history/` passes all tests
- `go build ./internal/ssh/` compiles
- `go build ./...` full project compiles
- `go vet ./...` no warnings
- History file uses 0600 permissions
- SSH connect sets Stdin/Stdout/Stderr to os.Stdin/Stdout/Stderr
</verification>

<success_criteria>
- internal/history/ package exists with RecordConnection, GetLastConnectedForPath, GetRecentHosts
- internal/ssh/connect.go exists with ConnectSSH and SSHFinishedMsg
- 10+ history tests pass with race detector
- sahilm/fuzzy is a direct dependency in go.mod
- Full project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-connection-navigation/03-01-SUMMARY.md`
</output>
