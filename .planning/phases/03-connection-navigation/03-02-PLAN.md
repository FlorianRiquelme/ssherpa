---
phase: 03-connection-navigation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - internal/tui/model.go
  - internal/tui/keys.go
  - internal/tui/list_view.go
  - internal/tui/detail_view.go
  - internal/tui/styles.go
  - internal/tui/messages.go
  - internal/config/config.go
  - internal/config/config_test.go
  - cmd/ssherpa/main.go
autonomous: false

must_haves:
  truths:
    - "User can type in always-on filter bar and list filters in real-time with fuzzy matching"
    - "Typing 'prd' matches 'production-server' (fuzzy, not substring)"
    - "Search matches against Host name, Hostname, and User fields simultaneously"
    - "Pressing Esc clears search text and returns focus to server list"
    - "'No matches' message displays when search returns zero results"
    - "Pressing Enter on selected server connects via SSH immediately (no confirmation)"
    - "SSH takes over terminal silently — TUI disappears, SSH runs natively"
    - "After SSH session ends, app exits to shell by default"
    - "Tab and 'i' open server detail view (Enter no longer opens details)"
    - "j/k, g/G, Ctrl+d/u navigate the list when search is not focused"
    - "Arrow keys, Page Up/Down, Home/End work for non-Vim users"
    - "q quits from list view (only when search bar is not focused)"
    - "Persistent footer bar shows context-sensitive key hints"
    - "Connection is recorded to history file before SSH handoff"
    - "On relaunch, last server connected from current working directory is preselected"
    - "Last-connected indicator (star) shown next to recently connected servers"
    - "Vim keys (j/k) type characters when search bar is focused (no navigation conflict)"
  artifacts:
    - path: "internal/tui/model.go"
      provides: "Refactored TUI model with search, SSH connect, history integration"
      min_lines: 200
    - path: "internal/tui/keys.go"
      provides: "KeyMap with Vim + standard bindings, help.KeyMap interface"
      exports: ["KeyMap", "DefaultKeyMap"]
    - path: "internal/tui/list_view.go"
      provides: "Updated list items with last-connected star indicator"
      min_lines: 50
    - path: "internal/tui/styles.go"
      provides: "Styles for search bar, star indicator, no-matches empty state"
      min_lines: 80
    - path: "internal/tui/messages.go"
      provides: "Updated messages including SSH finished message re-export"
      min_lines: 10
    - path: "internal/config/config.go"
      provides: "Config with ReturnToTUI field"
      contains: "ReturnToTUI"
    - path: "cmd/ssherpa/main.go"
      provides: "Updated main passing config and cwd to TUI"
      min_lines: 40
  key_links:
    - from: "internal/tui/model.go"
      to: "internal/ssh/connect.go"
      via: "ConnectSSH call on Enter key"
      pattern: "ssh\\.ConnectSSH"
    - from: "internal/tui/model.go"
      to: "internal/history/history.go"
      via: "RecordConnection before SSH handoff, GetLastConnectedForPath on init"
      pattern: "history\\.(RecordConnection|GetLastConnectedForPath)"
    - from: "internal/tui/model.go"
      to: "sahilm/fuzzy"
      via: "fuzzy.FindFrom for real-time search"
      pattern: "fuzzy\\.FindFrom"
    - from: "internal/tui/model.go"
      to: "internal/tui/keys.go"
      via: "key.Matches for input routing"
      pattern: "key\\.Matches.*m\\.keys"
    - from: "internal/tui/keys.go"
      to: "bubbles/help"
      via: "help.KeyMap interface (ShortHelp, FullHelp)"
      pattern: "func.*KeyMap.*ShortHelp"
    - from: "cmd/ssherpa/main.go"
      to: "internal/tui/model.go"
      via: "tui.New with config options"
      pattern: "tui\\.New"
---

<objective>
Overhaul the TUI to add fuzzy search, SSH connection handoff, keyboard navigation, connection history integration, and a persistent help footer — transforming the Phase 2 browsable list into a fully functional search-and-connect tool.

Purpose: This is the core user-facing deliverable of Phase 3. After this plan, users can launch ssherpa, fuzzy-search for a server, press Enter, and be connected via SSH — the primary workflow of the application.

Output: Fully reworked TUI with always-on search bar, fuzzy filtering, SSH connection via Enter, Vim+standard keybindings, help footer, history tracking, and last-connected preselection.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-connection-navigation/03-RESEARCH.md
@.planning/phases/03-connection-navigation/03-01-SUMMARY.md — History + SSH connect packages

@internal/tui/model.go — Current TUI model (will be heavily modified)
@internal/tui/list_view.go — Current list items (add star indicator)
@internal/tui/detail_view.go — Current detail view (update key hints)
@internal/tui/styles.go — Current styles (add search/star/empty-state styles)
@internal/tui/messages.go — Current messages (add new message types)
@internal/config/config.go — Current config (add ReturnToTUI field)
@internal/config/config_test.go — Current config tests (update for new field)
@internal/sshconfig/parser.go — SSHHost struct (referenced by fuzzy Source)
@cmd/ssherpa/main.go — Current main (pass config to TUI)
@go.mod — Dependencies
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config update, key bindings, and TUI model overhaul</name>
  <files>internal/config/config.go, internal/config/config_test.go, internal/tui/keys.go, internal/tui/model.go, internal/tui/list_view.go, internal/tui/detail_view.go, internal/tui/styles.go, internal/tui/messages.go, cmd/ssherpa/main.go</files>
  <action>
This is the main implementation task for Phase 3. It modifies multiple TUI files to add search, connection, and navigation capabilities.

**Step 1: Update config (`internal/config/config.go`)**

Add `ReturnToTUI` field to Config struct:
```go
type Config struct {
    Version     int  `toml:"version"`
    Backend     string `toml:"backend"`
    ReturnToTUI bool `toml:"return_to_tui_after_disconnect"` // default false = exit after SSH
}
```
No changes to Validate() — ReturnToTUI defaults to false (Go zero value), which means "exit after SSH" per user decision. Update config_test.go if any test assertions break due to new field.

**Step 2: Create key bindings (`internal/tui/keys.go`)**

Create new file with comprehensive KeyMap implementing `help.KeyMap` interface:

```go
type KeyMap struct {
    // Navigation
    Up           key.Binding
    Down         key.Binding
    PageUp       key.Binding
    PageDown     key.Binding
    HalfPageUp   key.Binding
    HalfPageDown key.Binding
    GoToTop      key.Binding
    GoToBottom   key.Binding
    // Actions
    Connect      key.Binding  // Enter
    Details      key.Binding  // Tab, i
    Search       key.Binding  // /
    Quit         key.Binding  // q
    // Search mode
    ClearSearch  key.Binding  // Esc
    ForceQuit    key.Binding  // Ctrl+C
}
```

DefaultKeyMap with:
- Up: keys("k", "up"), help("up/k", "up")
- Down: keys("j", "down"), help("down/j", "down")
- PageUp: keys("pgup"), help("pgup", "page up")
- PageDown: keys("pgdown"), help("pgdn", "page down")
- HalfPageUp: keys("ctrl+u"), help("C-u", "half page up")
- HalfPageDown: keys("ctrl+d"), help("C-d", "half page down")
- GoToTop: keys("g", "home"), help("g/home", "top")
- GoToBottom: keys("G", "end"), help("G/end", "bottom")
- Connect: keys("enter"), help("enter", "connect")
- Details: keys("tab", "i"), help("tab/i", "details")
- Search: keys("/"), help("/", "search")
- Quit: keys("q"), help("q", "quit")
- ClearSearch: keys("esc"), help("esc", "clear")
- ForceQuit: keys("ctrl+c"), help("", "") — hidden from help

Implement `ShortHelp() []key.Binding` returning [Connect, Details, Search, Quit] for list mode.
Implement `FullHelp() [][]key.Binding` with navigation group + action group.

Add `SearchKeyMap` struct with only ClearSearch binding for help in search mode:
```go
type SearchKeyMap struct {
    ClearSearch key.Binding
}
func (k SearchKeyMap) ShortHelp() []key.Binding { return []key.Binding{k.ClearSearch} }
func (k SearchKeyMap) FullHelp() [][]key.Binding { return [][]key.Binding{{k.ClearSearch}} }
```

**Step 3: Update styles (`internal/tui/styles.go`)**

Add new styles:
- `searchBarStyle` — for the filter bar container (subtle border/background)
- `searchLabelStyle` — for the "Filter:" / "Search:" label (accent color)
- `starIndicatorStyle` — for the last-connected star icon (accent color, e.g., "★")
- `noMatchesStyle` — for the "No matches" empty state (secondary color, italic, with padding)

**Step 4: Update messages (`internal/tui/messages.go`)**

Add message types:
- `sshFinishedMsg` — re-wraps `ssh.SSHFinishedMsg` (or import it directly, whichever is cleaner)
- `historyLoadedMsg` — carries `lastConnectedHost string` and `recentHosts map[string]time.Time` for initial preselection

Keep existing `configLoadedMsg`.

**Step 5: Update list_view.go (`internal/tui/list_view.go`)**

Modify `hostItem` struct to add `lastConnected bool` field.

Update `Title()` to prepend `★ ` (starIndicatorStyle) when `lastConnected` is true.

Update `FilterValue()` to return concatenated "Name Hostname User" for Bubbles' built-in filtering (though we'll use custom fuzzy search). Keep it returning multi-field string for compatibility.

**Step 6: Overhaul model.go (`internal/tui/model.go`)**

This is the largest change. The Model struct needs significant additions:

**New Model fields:**
```go
type Model struct {
    viewMode      ViewMode
    list          list.Model
    viewport      viewport.Model
    detailHost    *sshconfig.SSHHost
    spinner       spinner.Model
    loading       bool
    configPath    string
    hosts         []sshconfig.SSHHost
    err           error
    width         int
    height        int
    ready         bool

    // Phase 3 additions:
    searchInput   textinput.Model     // Always-on filter bar
    searchFocused bool                // Whether search bar has focus
    allHosts      []sshconfig.SSHHost // Unfiltered hosts (original order)
    filteredIdx   []int               // Indices into allHosts after fuzzy filter
    keys          KeyMap              // Key bindings
    help          help.Model          // Help footer component
    searchKeys    SearchKeyMap        // Key bindings for search mode help
    historyPath   string              // Path to history file
    returnToTUI   bool                // Config: return to TUI after SSH (default false)
    recentHosts   map[string]time.Time // Recent connections for star indicator
    lastConnHost  string              // Last connected host from cwd (for preselection)
}
```

**New() signature update:**

Change `New(configPath string)` to `New(configPath string, opts ...Option)` using functional options pattern, OR simply add parameters: `New(configPath, historyPath string, returnToTUI bool)`. Use the simpler approach:

```go
func New(configPath, historyPath string, returnToTUI bool) Model
```

Initialize:
- `textinput.New()` with Placeholder "Search servers...", CharLimit 100, Width adjusted to terminal
- `help.New()` for footer
- `DefaultKeyMap` and `SearchKeyMap{ClearSearch: DefaultKeyMap.ClearSearch}`
- `list.SetFilteringEnabled(false)` — we handle filtering manually with sahilm/fuzzy
- Store `historyPath` and `returnToTUI`

**Init() update:**

Return `tea.Batch(m.spinner.Tick, loadConfigCmd(m.configPath), loadHistoryCmd(m.historyPath))`.

Add `loadHistoryCmd(historyPath string) tea.Cmd` that:
1. Gets `os.Getwd()`
2. Calls `history.GetLastConnectedForPath(historyPath, cwd)`
3. Calls `history.GetRecentHosts(historyPath, 50)` — last 50 unique hosts
4. Returns `historyLoadedMsg{lastConnectedHost, recentHosts}`

**Update() overhaul:**

Complete rewrite of key handling logic. The critical structure:

```
1. Handle WindowSizeMsg (update all component sizes including search input width)
2. Handle configLoadedMsg (existing, but also store allHosts and apply history preselection)
3. Handle historyLoadedMsg (store recentHosts, lastConnHost, mark list items, preselect)
4. Handle spinner.TickMsg (existing)
5. Handle ssh.SSHFinishedMsg:
   - If returnToTUI is false: return tea.Quit
   - If returnToTUI is true: return to list view, reload config (in case SSH config changed)
6. Handle tea.KeyMsg:
   a. ForceQuit (ctrl+c) — always works: tea.Quit
   b. If loading — ignore other keys
   c. If ViewDetail:
      - esc/q → ViewList
      - Scroll keys → viewport.Update
   d. If ViewList AND searchFocused:
      - Esc → clear search, blur, defocus, refilter to show all
      - Enter → if filtered list has selection, connect to it (search + enter = quick connect)
      - All other keys → pass to textinput.Update, then refilter with fuzzy.FindFrom
   e. If ViewList AND NOT searchFocused:
      - "/" → focus search (searchFocused = true, searchInput.Focus())
      - "q" → tea.Quit
      - Enter → connect to selected server (record history BEFORE ssh handoff)
      - Tab or "i" → open detail view (reassigned from Phase 2's Enter)
      - Navigation keys → delegate to list.Update
      - g/G for top/bottom → list.CursorUp/Down to extremes (or set selected index)
      - Ctrl+d/u for half-page → calculate half page size from list height
```

**filterHosts() method:**

```go
func (m *Model) filterHosts() {
    query := m.searchInput.Value()
    if query == "" {
        // Show all hosts
        m.filteredIdx = make([]int, len(m.allHosts))
        for i := range m.allHosts { m.filteredIdx[i] = i }
    } else {
        // Fuzzy search across Name + Hostname + User
        source := hostSource(m.allHosts)
        matches := fuzzy.FindFrom(query, source)
        m.filteredIdx = make([]int, len(matches))
        for i, match := range matches {
            m.filteredIdx[i] = match.Index
        }
    }
    m.rebuildListItems()
}
```

**hostSource type** implementing `fuzzy.Source`:
```go
type hostSource []sshconfig.SSHHost

func (h hostSource) String(i int) string {
    return h[i].Name + " " + h[i].Hostname + " " + h[i].User
}
func (h hostSource) Len() int { return len(h) }
```

**rebuildListItems() method:**

Rebuilds `list.Item` slice from `filteredIdx`, applying:
- Star indicator if host Name is in `recentHosts` map
- Preserving wildcard separator (only if wildcards are in filtered results)
- Sets items on list component

**connectToHost() method:**

```go
func (m Model) connectToHost(host sshconfig.SSHHost) (Model, tea.Cmd) {
    // Record history BEFORE handoff (app may exit after SSH)
    if m.historyPath != "" {
        _ = history.RecordConnection(m.historyPath, host.Name, host.Hostname, host.User)
        // Ignore error — don't block connection for history failure
    }
    return m, ssh.ConnectSSH(host.Name)
}
```

**View() update:**

Restructure view rendering:

```
if !ready → "Initializing..."
if loading → spinner
if error with no hosts → error state
if no hosts → empty state

switch viewMode:
  ViewList:
    1. Search bar at TOP: searchLabelStyle.Render("Filter: ") + searchInput.View()
    2. Separator line
    3. If searchInput.Value() != "" && len(filteredIdx) == 0:
         noMatchesStyle.Render("No matches for \"...\"\nPress Esc to clear search")
       Else:
         list.View()
    4. help.View() — context-sensitive:
         if searchFocused: help.View(searchKeys)
         else: help.View(keys)

  ViewDetail:
    viewport.View() (existing, but update detail_view.go footer text)
```

**Step 7: Update detail_view.go**

Change footer help text from "Press Esc to go back | q to quit" to "Esc: back | Tab/i: next host | q: quit" (or similar, reflecting new key assignments).

**Step 8: Update main.go**

```go
func main() {
    // ... existing config loading ...

    // Determine history path
    historyPath := ""
    if homeDir != "" {
        historyPath = filepath.Join(homeDir, ".ssh", "ssherpa_history.json")
    }

    // Get return-to-TUI config option
    returnToTUI := false
    if cfg != nil {
        returnToTUI = cfg.ReturnToTUI
    }

    // Create TUI model with new parameters
    model := tui.New(sshConfigPath, historyPath, returnToTUI)

    // Run TUI
    p := tea.NewProgram(model, tea.WithAltScreen())
    if _, err := p.Run(); err != nil {
        fmt.Fprintf(os.Stderr, "Error running TUI: %v\n", err)
        os.Exit(1)
    }
}
```

**Critical implementation notes from research (MUST follow):**
- Filter on EVERY keystroke, not just on Enter — call filterHosts() after every textinput.Update()
- Intercept Esc BEFORE passing to textinput — textinput swallows Esc otherwise
- Disable Vim keys (j/k/g/G) when search is focused — they must type as characters
- Record history BEFORE SSH handoff — app may exit after SSH session
- Set cmd.Stdin/Stdout/Stderr to os.Stdin/Stdout/Stderr (handled in ssh/connect.go from Plan 01)
- Help footer must change based on search focus state (show ClearSearch in search, full keys in list)
- Use per-decision research: filter bar at TOP (familiar browser pattern), star icon "★" for last-connected, "i" for detail view Vim alternative
  </action>
  <verify>
Run `go build ./...` — full project compiles cleanly.
Run `go vet ./...` — no warnings.
Run `go test -race ./internal/config/` — config tests pass.
Run `go run ./cmd/ssherpa/` — TUI launches with search bar visible at top.
  </verify>
  <done>
TUI has always-on filter bar at top with real-time fuzzy search, Enter connects to SSH, Tab/i opens details, full Vim+standard keyboard navigation, persistent context-sensitive help footer, connection history recording, last-connected preselection, and star indicators for recent connections. All compile cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify full search-and-connect flow</name>
  <what-built>
Complete Phase 3 TUI overhaul: fuzzy search, SSH connection, keyboard navigation, history tracking, and help footer.
  </what-built>
  <how-to-verify>
**Build and launch:**
```bash
go run ./cmd/ssherpa/
```

**1. Search bar (top of screen):**
- [ ] Filter bar visible at top showing placeholder "Search servers..."
- [ ] Press `/` — cursor moves to search bar
- [ ] Type a partial server name (e.g., "prd") — list filters in real-time
- [ ] Fuzzy matching works: "prd" matches "production-server"
- [ ] Type something with no matches — "No matches" message appears
- [ ] Press `Esc` — search clears, full list returns, cursor back to list

**2. SSH connection:**
- [ ] Select a server with arrow keys or j/k
- [ ] Press `Enter` — TUI disappears, SSH session starts (or shows SSH error)
- [ ] If SSH succeeded: after disconnecting, you return to your shell (default behavior)
- [ ] If SSH failed: native SSH error is visible, app exits

**3. Keyboard navigation:**
- [ ] j/k moves up/down in list
- [ ] g goes to top, G goes to bottom
- [ ] Ctrl+d/u scrolls half page
- [ ] Arrow keys, Page Up/Down, Home/End all work
- [ ] q quits from list view
- [ ] When search is focused: j/k type characters (don't navigate)

**4. Detail view:**
- [ ] Press Tab on a server — full detail view opens
- [ ] Press i on a server — same detail view opens
- [ ] Press Esc in detail view — returns to list

**5. Help footer:**
- [ ] Footer visible at bottom: "enter: connect | tab/i: details | /: search | q: quit" (or similar)
- [ ] When search is focused: footer changes to show "esc: clear" (or similar)

**6. History & preselection:**
- [ ] After connecting to a server and relaunching, that server has a ★ indicator
- [ ] If relaunching from the same directory, the last-connected server is preselected

**7. Overall feel:**
- [ ] Connection feels like running `ssh` directly — zero friction
- [ ] Non-Vim users can navigate with arrow keys and understand the footer hints
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `go build ./...` compiles
- `go test -race ./...` all tests pass
- `go vet ./...` no warnings
- TUI launches with search bar, help footer, and server list
- Fuzzy search filters in real-time on every keystroke
- Enter connects to SSH with silent handoff
- Tab/i opens detail view (Enter no longer opens details)
- Esc clears search and returns focus to list
- Vim keys work in list mode, type as characters in search mode
- History file created at ~/.ssh/ssherpa_history.json after first connection
- Star indicator appears next to recently connected servers
</verification>

<success_criteria>
- User can fuzzy-search servers by name, hostname, or user
- Search updates in real-time as user types
- User can select a server and press Enter to initiate SSH connection
- SSH opens in current terminal session via tea.ExecProcess handoff
- After SSH session ends, app exits to shell (default behavior)
- Tab/i opens detail view, Esc clears search, q quits
- Persistent footer shows context-sensitive key hints
- Connection history tracked in ~/.ssh/ssherpa_history.json
- Last-connected server preselected on relaunch from same directory
- Star indicator shown next to recently connected servers
</success_criteria>

<output>
After completion, create `.planning/phases/03-connection-navigation/03-02-SUMMARY.md`
</output>
