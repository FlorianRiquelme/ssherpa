---
phase: 04-project-detection
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - internal/tui/picker.go
  - internal/tui/model.go
  - internal/tui/keys.go
  - internal/tui/styles.go
  - internal/project/matcher.go
  - internal/project/matcher_test.go
  - internal/config/config.go
autonomous: false

must_haves:
  truths:
    - "User can press a key on a server to open project picker overlay"
    - "Project picker shows known projects plus option to create new project"
    - "Selecting a project assigns the server to it (many-to-many)"
    - "Assignment persists to TOML config after selection"
    - "Picker auto-suggests projects based on hostname pattern matching"
    - "Server can belong to multiple projects"
  artifacts:
    - path: "internal/tui/picker.go"
      provides: "Project picker overlay component"
      exports: ["ProjectPicker"]
    - path: "internal/project/matcher.go"
      provides: "Hostname pattern matching for project auto-suggestions"
      exports: ["SuggestProjects"]
    - path: "internal/tui/model.go"
      provides: "Model with picker overlay integration"
      contains: "showingPicker"
    - path: "internal/tui/keys.go"
      provides: "Key binding for project picker"
      contains: "AssignProject"
  key_links:
    - from: "internal/tui/picker.go"
      to: "internal/config/config.go"
      via: "config.Save to persist assignment"
      pattern: "config\\.Save"
    - from: "internal/tui/picker.go"
      to: "internal/project/matcher.go"
      via: "matcher.SuggestProjects for auto-suggestions"
      pattern: "matcher\\.SuggestProjects|SuggestProjects"
    - from: "internal/tui/model.go"
      to: "internal/tui/picker.go"
      via: "showingPicker state toggle on key press"
      pattern: "showingPicker"
---

<objective>
Implement the project picker overlay for manual server-to-project assignment with hostname-based auto-suggestions, enabling users to organize servers into projects directly from the TUI.

Purpose: Auto-detection only works for the current repo. Users need a way to manually assign servers to projects for servers that don't match any git remote. This completes the PROJ-03 requirement.

Output: Project picker overlay, hostname matcher, and persistent assignment to TOML config.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-detection/04-RESEARCH.md
@.planning/phases/04-project-detection/04-CONTEXT.md
@.planning/phases/04-project-detection/04-01-SUMMARY.md
@.planning/phases/04-project-detection/04-02-SUMMARY.md
@internal/tui/model.go
@internal/tui/list_view.go
@internal/tui/keys.go
@internal/tui/styles.go
@internal/tui/picker.go
@internal/tui/badges.go
@internal/project/detector.go
@internal/project/colors.go
@internal/config/config.go
@cmd/ssherpa/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hostname pattern matcher for auto-suggestions (TDD)</name>
  <files>
    internal/project/matcher.go
    internal/project/matcher_test.go
    go.mod
    go.sum
  </files>
  <action>
**Install dependency:**
```bash
go get github.com/agnivade/levenshtein
```

**RED phase.** Create `internal/project/matcher_test.go` with:

1. `TestSuggestProjects_ExactSubdomainMatch` - Server hostname `api-prod-02.acme.com`, existing project has servers `api-prod-01.acme.com` -> suggests that project (high score)
2. `TestSuggestProjects_SimilarPrefix` - Server `db-staging.acme.com`, project has `db-prod.acme.com` -> suggests (medium score)
3. `TestSuggestProjects_Unrelated` - Server `mail.other.com`, project has `api-prod.acme.com` -> does NOT suggest (below 70% threshold)
4. `TestSuggestProjects_MultipleProjects` - Server matches 2 projects, returns both sorted by relevance
5. `TestSuggestProjects_MaxThree` - Even if many projects match, returns at most 3 suggestions
6. `TestSuggestProjects_NoProjects` - Empty project list returns empty suggestions
7. `TestSuggestProjects_IgnoreNumericSuffix` - `api-prod-01` and `api-prod-02` treated as very similar (numeric suffix `-01`, `-02` ignored for matching)

**GREEN phase.** Create `internal/project/matcher.go`:

```go
// SuggestProjects returns up to 3 project suggestions for a server hostname
// based on hostname pattern similarity with existing project members.
// Only returns suggestions with similarity score >= 70%.
func SuggestProjects(serverHostname string, projects []ProjectMember) []Suggestion

type ProjectMember struct {
    ProjectID   string
    ProjectName string
    Hostnames   []string // Hostnames of servers already in this project
}

type Suggestion struct {
    ProjectID   string
    ProjectName string
    Score       float64 // 0.0 to 1.0
}
```

**Hostname similarity algorithm:**
1. Split hostname by `.` and `-` into segments
2. Strip numeric-only segments (ignore `-01`, `-02` etc.)
3. Compare remaining segments between candidate and project member hostnames
4. Weight leftmost segments higher (subdomain > domain > TLD): weights 1.0, 0.8, 0.6, 0.4, 0.2 descending
5. For each segment pair, compute similarity as `1.0 - (levenshtein_distance / max(len(a), len(b)))`
6. Multiply segment similarity by weight, sum, normalize by total weight
7. For each project: compute max similarity across all member hostnames
8. Filter by threshold >= 0.7, sort descending, return top 3

Use `github.com/agnivade/levenshtein` for edit distance computation.
  </action>
  <verify>
```bash
go test -race -v ./internal/project/...
```
All matcher tests pass.
  </verify>
  <done>
- SuggestProjects returns relevant project suggestions based on hostname similarity
- Similar hostnames (same prefix, different numeric suffix) score high
- Unrelated hostnames score below threshold and are excluded
- Max 3 suggestions returned, sorted by relevance
  </done>
</task>

<task type="auto">
  <name>Task 2: Project picker overlay and persistent assignment</name>
  <files>
    internal/tui/picker.go
    internal/tui/model.go
    internal/tui/keys.go
    internal/tui/styles.go
    internal/config/config.go
  </files>
  <action>
**Create `internal/tui/picker.go` - Project picker overlay component:**

The picker is a lightweight popup menu (NOT full-screen), rendered as an overlay on top of the server list. Keep it simple -- do NOT use bubbletea-overlay library (it may have compatibility issues with bubbletea v2 alpha). Instead, implement a simple overlay by rendering the picker view over the main view in the `View()` method using lipgloss positioning.

**Picker component structure:**

```go
type ProjectPicker struct {
    items       []pickerItem   // Available projects + "Create new..."
    selected    int            // Currently highlighted item
    serverName  string         // SSH host name being assigned
    suggestions []string       // Auto-suggested project IDs (highlighted in list)
    width       int
    height      int
}

type pickerItem struct {
    projectID   string
    projectName string
    isNew       bool           // "Create new project..." option
    isSuggested bool           // Highlighted as auto-suggestion
    isAssigned  bool           // Server already belongs to this project
}
```

**Picker behavior:**
- Shows list of all known projects from config
- Auto-suggested projects (from hostname matcher) appear at top with a visual indicator (e.g., star or "suggested" label)
- Projects the server already belongs to show a checkmark
- Last item: "+ Create new project..." (creates a project with auto-detected name if in git repo, otherwise prompts for name)
- Navigation: j/k or arrows to move, Enter to toggle assignment (add/remove), Esc to close
- Multiple selection supported (server can belong to multiple projects per user decision)

**Picker messages:**
```go
type projectAssignedMsg struct {
    serverName string
    projectID  string
    assigned   bool  // true = added, false = removed
}

type projectCreatedMsg struct {
    project config.ProjectConfig
}
```

**Update `internal/tui/keys.go`:**

Add `AssignProject` key binding:
```go
AssignProject: key.NewBinding(
    key.WithKeys("p"),
    key.WithHelp("p", "project"),
),
```

Add to `ShortHelp()` output so it appears in the help footer.

**Update `internal/tui/model.go`:**

Add picker state:
```go
picker        *ProjectPicker  // nil when not showing
showingPicker bool
```

In `Update()` for `KeyMsg` in list mode (not search focused):
- When `key.Matches(msg, m.keys.AssignProject)`: Get selected server, compute auto-suggestions via `project.SuggestProjects()`, create picker with current projects and suggestions, set `showingPicker = true`
- When `showingPicker` is true, route ALL key events to picker (not list)

Handle picker messages:
- `projectAssignedMsg`: Update the project's `ServerNames` in config, call `config.Save()` to persist to TOML, rebuild list items to update badges
- `projectCreatedMsg`: Add new project to config, save, rebuild list

In `View()`:
- When `showingPicker`: Render picker centered over the list view. Use lipgloss `Place()` to center the picker box over the main content. The picker box should have a border, title, and be approximately 40-60 chars wide.

**Update `internal/tui/styles.go`:**

Add picker overlay styles:
```go
pickerBorderStyle = lipgloss.NewStyle().
    Border(lipgloss.RoundedBorder()).
    BorderForeground(accentColor).
    Padding(1, 2).
    Width(50)

pickerTitleStyle = lipgloss.NewStyle().
    Bold(true).
    Foreground(accentColor)

pickerSelectedStyle = lipgloss.NewStyle().
    Foreground(lipgloss.Color("#FFFFFF")).
    Background(accentColor).
    Bold(true)

pickerSuggestedStyle = lipgloss.NewStyle().
    Foreground(accentColor).
    Italic(true)

pickerCheckmarkStyle = lipgloss.NewStyle().
    Foreground(lipgloss.AdaptiveColor{Light: "#16A34A", Dark: "#4ADE80"}).
    Bold(true)
```

**Persistence flow:**
When user toggles a project assignment in the picker:
1. Find the ProjectConfig in m.projects by ID
2. If assigning: append serverName to project.ServerNames (if not already present)
3. If unassigning: remove serverName from project.ServerNames
4. Update m.projects and m.projectMap
5. Save config with `config.Save()` -- need to pass config path to model (add `configFilePath` field to Model, populated from main.go)
6. Rebuild list items to reflect new badges

**Update `internal/config/config.go` if needed:**
Ensure `Save()` can handle the updated config with projects. The existing Save function should work since it encodes the full Config struct.

Add a helper method if useful:
```go
func (c *Config) FindProject(id string) *ProjectConfig
func (c *Config) AddServerToProject(projectID, serverName string)
func (c *Config) RemoveServerFromProject(projectID, serverName string)
```

**"Create new project" flow:**
When user selects "+ Create new project..." in picker:
1. Switch picker to "name input" mode (show a text input)
2. Pre-fill with auto-detected org/repo if in git repo, otherwise empty
3. On Enter: create ProjectConfig with generated UUID, name from input, assign current server
4. Send `projectCreatedMsg`
5. Picker closes

For UUID generation, use a simple approach: `fmt.Sprintf("proj-%d", time.Now().UnixNano())` -- no need for a UUID library for this.
  </action>
  <verify>
```bash
go build ./...
go vet ./...
# Visual verification via checkpoint below
```
  </verify>
  <done>
- "p" key opens project picker overlay on selected server
- Picker shows all known projects with auto-suggestions highlighted
- Toggle assignment with Enter (add/remove server from project)
- "Create new project" option at bottom creates and assigns
- Assignments persist to TOML config file
- Picker closes with Esc, badges update immediately
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify project picker and full Phase 4 workflow</name>
  <what-built>
Project picker overlay with hostname-based auto-suggestions, many-to-many server-project assignment, and persistent TOML storage. Full Phase 4 feature set complete.
  </what-built>
  <how-to-verify>
1. **Open project picker:**
   - Run `go run ./cmd/ssherpa/`
   - Navigate to any server, press `p`
   - Verify: Overlay popup appears centered over the server list
   - Verify: Shows known projects (if any configured)
   - Verify: Shows "+ Create new project..." at bottom
   - Verify: Esc closes the picker without changes

2. **Create a new project:**
   - Press `p` on a server
   - Navigate to "+ Create new project..."
   - Press Enter
   - Type a project name (e.g., "test/project")
   - Press Enter to confirm
   - Verify: Badge appears on the server immediately
   - Verify: Check `~/.config/ssherpa/config.toml` -- new `[[project]]` entry exists with `server_names` containing the host

3. **Assign server to existing project:**
   - Press `p` on a different server
   - Navigate to the project created in step 2
   - Press Enter to assign
   - Verify: Checkmark appears next to project name in picker
   - Verify: Badge appears on server after closing picker

4. **Unassign server from project:**
   - Press `p` on the server just assigned
   - Navigate to the project (should show checkmark)
   - Press Enter to toggle off
   - Verify: Checkmark disappears
   - Verify: Badge removed from server after closing picker

5. **Multiple project assignment:**
   - Create a second project
   - Assign a server to both projects
   - Verify: Server shows two colored badges
   - Verify: TOML config has the server name in both project's `server_names`

6. **Auto-suggestions:**
   - Assign several servers with similar hostnames (e.g., `api-prod-01`, `api-prod-02`) to one project
   - Press `p` on a server with a similar hostname (e.g., `api-staging-01`)
   - Verify: The project appears as a suggestion (highlighted or marked in picker list)

7. **Full workflow verification:**
   - Configure projects in TOML, assign servers
   - Quit and relaunch TUI
   - Verify: Badges persist, grouping intact, search prioritization works
   - Verify: All Phase 3 features still work (search, connect, details, navigation)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
```bash
# All project tests pass (detector + colors + matcher)
go test -race -v ./internal/project/...

# All config tests pass
go test -race -v ./internal/config/...

# Full build succeeds
go build ./...

# No vet warnings
go vet ./...

# Visual verification via checkpoint
```
</verification>

<success_criteria>
1. User can press "p" on any server to open project picker overlay
2. Picker shows all known projects with auto-suggestions highlighted
3. Enter toggles server-project assignment (many-to-many)
4. "Create new project" option works with name input
5. Assignments persist to TOML config across TUI sessions
6. Hostname matcher suggests relevant projects based on similar server names
7. All Phase 3 features preserved after Phase 4 additions
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-detection/04-03-SUMMARY.md`
</output>
