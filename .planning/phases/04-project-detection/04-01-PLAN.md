---
phase: 04-project-detection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/project/detector.go
  - internal/project/detector_test.go
  - internal/project/colors.go
  - internal/project/colors_test.go
  - internal/config/config.go
  - internal/config/config_test.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "DetectCurrentProject returns org/repo from git origin remote URL"
    - "SSH URLs (git@github.com:org/repo.git) parse to org/repo"
    - "HTTPS URLs (https://github.com/org/repo.git) parse to org/repo"
    - "Missing origin remote returns empty string without error"
    - "Bare repos and non-git directories return empty string without error"
    - "ProjectColor generates deterministic colors from project IDs"
    - "Same project ID always produces same color across calls"
    - "Different project IDs produce different colors"
    - "Config supports [[project]] TOML array-of-tables for project storage"
    - "ProjectConfig includes ServerNames for server-to-project mapping"
  artifacts:
    - path: "internal/project/detector.go"
      provides: "Git remote URL detection and org/repo extraction"
      exports: ["DetectCurrentProject"]
    - path: "internal/project/colors.go"
      provides: "Deterministic project badge color generation"
      exports: ["ProjectColor"]
    - path: "internal/config/config.go"
      provides: "TOML config with project storage"
      contains: "ProjectConfig"
  key_links:
    - from: "internal/project/detector.go"
      to: "git CLI"
      via: "exec.Command git config --get remote.origin.url"
      pattern: "exec\\.Command.*git.*config"
    - from: "internal/project/detector.go"
      to: "github.com/whilp/git-urls"
      via: "giturls.Parse"
      pattern: "giturls\\.Parse"
    - from: "internal/project/colors.go"
      to: "hash/fnv"
      via: "FNV hash for deterministic hue"
      pattern: "fnv\\.New32a"
---

<objective>
Implement git remote URL detection that extracts org/repo project identifiers and deterministic badge color generation, with TOML config storage for projects.

Purpose: This is the foundation for all project detection features. Without reliable git URL parsing and project persistence, the TUI cannot group servers or detect the current project.

Output: `internal/project/` package with detector and colors, updated `internal/config/` with project storage. All with comprehensive TDD tests.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-detection/04-RESEARCH.md
@.planning/phases/04-project-detection/04-CONTEXT.md
@internal/domain/project.go
@internal/domain/server.go
@internal/config/config.go
@internal/config/config_test.go
@go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Git remote detection and project color generation (TDD)</name>
  <files>
    internal/project/detector.go
    internal/project/detector_test.go
    internal/project/colors.go
    internal/project/colors_test.go
    go.mod
    go.sum
  </files>
  <action>
**RED phase first.** Create test files before implementation.

**Install dependency:**
```bash
go get github.com/whilp/git-urls
```

**Create `internal/project/detector_test.go`** with these test cases:

1. `TestExtractOrgRepo_SSHUrl` - Input: `git@github.com:acme/backend-api.git` -> Output: `acme/backend-api`
2. `TestExtractOrgRepo_HTTPSUrl` - Input: `https://github.com/acme/backend-api.git` -> Output: `acme/backend-api`
3. `TestExtractOrgRepo_HTTPSNoGitSuffix` - Input: `https://github.com/acme/backend-api` -> Output: `acme/backend-api`
4. `TestExtractOrgRepo_GitLabNestedGroup` - Input: `git@gitlab.com:company/team/service.git` -> Output: `company/team/service`
5. `TestExtractOrgRepo_EmptyUrl` - Input: `""` -> Output: `""`, no error
6. `TestExtractOrgRepo_MalformedUrl` - Input: `not-a-url` -> handle gracefully (return empty or error, but do NOT panic)
7. `TestDetectCurrentProject_NotGitRepo` - Run `DetectCurrentProject` in a temp dir with no `.git` -> returns `""`, nil error
8. `TestDetectCurrentProject_NoOriginRemote` - Create a bare git repo with no origin -> returns `""`, nil error

Note: `DetectCurrentProject` shells out to `git config --get remote.origin.url` so it needs real git repos for integration tests. Use `t.TempDir()` with `git init` for test setup.

**Create `internal/project/colors_test.go`** with:

1. `TestProjectColor_Deterministic` - Same project ID produces same color on repeated calls
2. `TestProjectColor_DifferentProjects` - Different IDs produce different hues (test with 5+ distinct IDs, assert not all identical)
3. `TestProjectColor_EmptyID` - Empty string does not panic, returns a valid color

**GREEN phase.** Implement:

**`internal/project/detector.go`:**
- `ExtractOrgRepo(remoteURL string) (string, error)` - Pure function: parses URL with `giturls.Parse()`, extracts path, trims leading `/` and trailing `.git`, returns org/repo string. Returns `""` for empty input.
- `DetectCurrentProject() (string, error)` - Runs `git config --get remote.origin.url` via `exec.Command`. If command fails (not git repo, no origin), returns `""`, nil (NOT an error per user decision). Passes output to `ExtractOrgRepo`.

Per user decision: Only the `origin` remote is used. Bare repos, missing origin = return empty string, not error.

**`internal/project/colors.go`:**
- `ProjectColor(projectID string) lipgloss.AdaptiveColor` - Uses FNV-1a hash of project ID to generate hue (0-359). Converts HSL to hex color string with fixed saturation (65%) and lightness (40% for light terminals, 70% for dark terminals). Returns `lipgloss.AdaptiveColor` with light/dark variants.
- Helper: `hslToHex(h, s, l float64) string` - Standard HSL-to-RGB-to-hex conversion.

Use hex color strings (e.g., `"#5A67D8"`) for lipgloss compatibility, NOT ANSI 256 codes. Hex colors are more precise and lipgloss handles degradation automatically.

Run `go test -race -v ./internal/project/...` to verify all tests pass.
  </action>
  <verify>
```bash
go test -race -v ./internal/project/...
```
All tests pass. `go vet ./internal/project/...` clean.
  </verify>
  <done>
- ExtractOrgRepo correctly parses SSH, HTTPS, and nested group URLs
- DetectCurrentProject returns empty string (not error) for non-git dirs and missing origin
- ProjectColor generates deterministic, distinct colors for different project IDs
- All tests pass with race detector
  </done>
</task>

<task type="auto">
  <name>Task 2: TOML config storage for projects (TDD)</name>
  <files>
    internal/config/config.go
    internal/config/config_test.go
  </files>
  <action>
**RED phase first.** Add test cases to existing `internal/config/config_test.go`:

1. `TestConfigWithProjects_SaveAndLoad` - Create config with 2 projects (each having ID, Name, GitRemoteURLs, Color), save to TOML, reload, verify all fields preserved
2. `TestConfigWithProjects_EmptyProjects` - Config with empty Projects slice saves/loads correctly (no `[[project]]` entries in TOML)
3. `TestConfigWithProjects_MultipleRemoteURLs` - Project with multiple GitRemoteURLs round-trips correctly
4. `TestConfigWithProjects_ServerNames` - Project with ServerNames round-trips correctly (many-to-many mapping)

**GREEN phase.** Update `internal/config/config.go`:

Add `ProjectConfig` struct:
```go
type ProjectConfig struct {
    ID            string   `toml:"id"`
    Name          string   `toml:"name"`
    GitRemoteURLs []string `toml:"git_remote_urls"`
    Color         string   `toml:"color,omitempty"`        // User-overridden color hex, empty = auto
    ServerNames   []string `toml:"server_names,omitempty"` // SSH config host aliases in this project
}
```

Add to `Config` struct:
```go
Projects []ProjectConfig `toml:"project"` // TOML array-of-tables: [[project]]
```

This uses TOML's `[[project]]` array-of-tables syntax. The `toml:"project"` tag maps to `[[project]]` in TOML.

The `Color` field is optional (`omitempty`). When empty, the TUI uses `ProjectColor()` for auto-generation. When set, the TUI uses the user's chosen color.

Do NOT change the `Version`, `Backend`, or `ReturnToTUI` fields.

Run tests to verify round-trip persistence works.
  </action>
  <verify>
```bash
go test -race -v ./internal/config/...
```
All tests pass (both existing and new). TOML output contains `[[project]]` entries.
  </verify>
  <done>
- ProjectConfig struct exists with ID, Name, GitRemoteURLs, Color fields
- Config.Projects field stores project configurations
- TOML round-trip preserves all project fields including multi-value GitRemoteURLs
- Existing config tests still pass (no regression)
  </done>
</task>

</tasks>

<verification>
```bash
# All project package tests pass
go test -race -v ./internal/project/...

# All config package tests pass (including new project storage tests)
go test -race -v ./internal/config/...

# Full build succeeds
go build ./...

# No vet warnings
go vet ./...
```
</verification>

<success_criteria>
1. `DetectCurrentProject()` returns `org/repo` from origin remote URL (SSH and HTTPS)
2. Non-git directories and missing origin return empty string, not error
3. `ProjectColor()` generates deterministic colors (same input = same output)
4. Config TOML supports `[[project]]` array-of-tables with round-trip persistence
5. All tests pass with `-race` flag
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-detection/04-01-SUMMARY.md`
</output>
