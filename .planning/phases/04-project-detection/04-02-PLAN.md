---
phase: 04-project-detection
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - internal/tui/model.go
  - internal/tui/list_view.go
  - internal/tui/styles.go
  - internal/tui/messages.go
  - internal/tui/badges.go
  - cmd/ssherpa/main.go
autonomous: false

must_haves:
  truths:
    - "Each server row shows colored project badge(s) inline"
    - "Servers are sorted by project name with same-project servers clustered together"
    - "Current project's cluster appears first when launched inside a git repo"
    - "Unassigned servers (no project) appear at the bottom of the list"
    - "Fuzzy search shows current project matches first, other matches below a separator"
    - "Outside a git repo, all servers grouped by project (no current project concept)"
    - "Badges use deterministic auto-generated colors per project"
  artifacts:
    - path: "internal/tui/badges.go"
      provides: "Project badge rendering with inline colored labels"
      exports: ["RenderProjectBadge"]
    - path: "internal/tui/model.go"
      provides: "TUI model with project-aware grouping and search"
      contains: "currentProjectID"
    - path: "internal/tui/list_view.go"
      provides: "Host items with project badge display"
      contains: "projectBadge"
    - path: "cmd/ssherpa/main.go"
      provides: "Main entry point passing project context to TUI"
      contains: "DetectCurrentProject"
  key_links:
    - from: "cmd/ssherpa/main.go"
      to: "internal/project/detector.go"
      via: "project.DetectCurrentProject() at startup"
      pattern: "project\\.DetectCurrentProject"
    - from: "internal/tui/model.go"
      to: "internal/project/colors.go"
      via: "project.ProjectColor for badge rendering"
      pattern: "project\\.ProjectColor"
    - from: "internal/tui/model.go"
      to: "internal/config/config.go"
      via: "config.ProjectConfig for project data"
      pattern: "config\\.ProjectConfig"
    - from: "internal/tui/list_view.go"
      to: "internal/tui/badges.go"
      via: "RenderProjectBadge in Title()"
      pattern: "RenderProjectBadge"
---

<objective>
Overhaul the TUI to display servers grouped by project with colored inline badges, current-project-first ordering, and project-aware fuzzy search with separator between current and other matches.

Purpose: This transforms the flat server list into a project-organized view that automatically surfaces relevant servers for the user's current git project. This is the core UX differentiator of ssherpa.

Output: Updated TUI with project badges, grouping, and search priority. Users see their current project's servers first with colored project labels.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-project-detection/04-RESEARCH.md
@.planning/phases/04-project-detection/04-CONTEXT.md
@.planning/phases/04-project-detection/04-01-SUMMARY.md
@internal/tui/model.go
@internal/tui/list_view.go
@internal/tui/styles.go
@internal/tui/messages.go
@internal/tui/keys.go
@internal/domain/project.go
@internal/domain/server.go
@internal/config/config.go
@cmd/ssherpa/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project badges, grouped list, and project-aware search</name>
  <files>
    internal/tui/badges.go
    internal/tui/model.go
    internal/tui/list_view.go
    internal/tui/styles.go
    internal/tui/messages.go
    cmd/ssherpa/main.go
  </files>
  <action>
This is a comprehensive TUI overhaul. Work through these changes methodically:

**1. Create `internal/tui/badges.go`:**

```go
// RenderProjectBadge creates an inline GitHub-label-style badge.
// Uses white text on colored background with padding.
func RenderProjectBadge(projectName string, color lipgloss.AdaptiveColor) string
```

Badge style: white bold text, colored background, `Padding(0, 1)`, inline rendering. Should look like GitHub labels: `[acme/backend]` with color fill.

**2. Update `cmd/ssherpa/main.go`:**

At startup (before creating TUI model):
- Call `project.DetectCurrentProject()` to get the current project's org/repo identifier
- Load `config.Projects` from config (the `[]ProjectConfig` added in Plan 01)
- Pass both `currentProjectID string` and `projects []config.ProjectConfig` to `tui.New()`
- If `DetectCurrentProject()` returns empty string (not in git repo, no origin), pass empty string -- TUI will handle it

**3. Update `tui.New()` signature** to accept:
```go
func New(configPath, historyPath string, returnToTUI bool, currentProjectID string, projects []config.ProjectConfig) Model
```

Add to Model struct:
```go
currentProjectID string                    // Detected from git, empty if not in repo
projects         []config.ProjectConfig    // Project configs from TOML
projectMap       map[string]config.ProjectConfig // Project ID -> config, for fast lookup
```

In `New()`, build `projectMap` from projects slice (key = project ID, also key = project name for matching by org/repo identifier).

**4. Update `internal/tui/messages.go`:**

Add a new `projectSeparatorItem` type (or reuse/rename `separatorItem`):
```go
type projectSeparatorItem struct {
    label string // e.g., "Other Projects" or thin horizontal rule
}
```
Implements `list.Item` with empty `FilterValue()`.

**5. Update `internal/tui/list_view.go`:**

Modify `hostItem` to include project badge data:
```go
type hostItem struct {
    host          sshconfig.SSHHost
    lastConnected bool
    projectBadges []badgeData // Project badges to render inline
}

type badgeData struct {
    name  string
    color lipgloss.AdaptiveColor
}
```

Update `Title()` to render project badges inline AFTER the server name:
```go
func (h hostItem) Title() string {
    // Build: [star] Name (hostname) [badge1] [badge2]
    prefix := ""
    if h.lastConnected {
        prefix = starIndicatorStyle.Render("* ")
    }

    title := fmt.Sprintf("%s (%s)",
        hostnameStyle.Render(h.host.Name),
        h.host.Hostname)

    // Append project badges
    for _, badge := range h.projectBadges {
        title += " " + RenderProjectBadge(badge.name, badge.color)
    }

    // Warning indicator
    if h.host.ParseError != nil {
        title = warningStyle.Render("! ") + title
    }

    return prefix + title
}
```

Per user decision: badges are inline labels (not section headers or collapsible sections).

**6. Overhaul `rebuildListItems()` in `internal/tui/model.go`:**

This is the core logic. Replace the current regular/wildcard split with project-aware grouping.

**Grouping algorithm (when search query is empty):**

```
The TUI works with sshconfig.SSHHost structs (from SSH config parser), NOT domain.Server structs.
Project-to-server mapping uses ProjectConfig.ServerNames (created in Plan 01) which stores SSH
config host aliases belonging to each project.
```

**Grouping logic for `rebuildListItems()` (no search query):**

```
1. Build host->project map: for each project in m.projects, for each serverName in project.ServerNames, map serverName -> []projectConfig
2. Separate hosts into: currentProject, otherProjects (grouped by project name), unassigned
3. Sort:
   a. Current project hosts first (sorted by name within group)
   b. Other project groups sorted alphabetically by project name, hosts sorted within
   c. Unassigned hosts last
4. Build list items with project badges
5. Add separatorItem between current project and others (if both non-empty)
6. Wildcards always go to bottom (after unassigned)
```

**Search logic for `filterHosts()` (with search query):**

Use `fuzzy.FindFromNoSort()` to get unsorted matches, then:
1. Split matches into currentProject vs others (using host->project map)
2. Sort each group by fuzzy score (descending)
3. Insert `projectSeparatorItem` between current project results and other results
4. If currentProjectID is empty (not in repo), skip separation -- just sort by score with project grouping

Per user decision: "Fuzzy search: current project matches appear first, other matches below a separator"

**7. Update `internal/tui/styles.go`:**

Add badge-related styles:
```go
// Project badge base style (white text on colored background)
badgeStyle = lipgloss.NewStyle().
    Foreground(lipgloss.Color("#FFFFFF")).
    Bold(true).
    Padding(0, 1)

// Project separator between current and other projects
projectSeparatorStyle = lipgloss.NewStyle().
    Foreground(secondaryColor).
    Italic(true)
```

**CRITICAL: Maintain existing functionality.** All Phase 3 features must still work:
- Fuzzy search still filters in real-time
- Enter still connects to SSH
- Tab/i still shows details
- Vim navigation still works
- History indicators (star) still display
- Wildcard entries still separated at bottom

The project badges and grouping are ADDITIONS to the existing list, not replacements.

When there are no projects configured, the TUI should behave exactly as before (flat list, no badges).
  </action>
  <verify>
```bash
go build ./...
go vet ./...
# Launch and visually verify:
# go run ./cmd/ssherpa/
```
  </verify>
  <done>
- Server list shows colored project badges inline on each row
- Servers grouped by project (current first, others alphabetical, unassigned last)
- Fuzzy search prioritizes current project matches above separator
- All Phase 3 features preserved (search, connect, navigation, history)
- No badges when no projects configured (graceful degradation)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify project-aware TUI display and interaction</name>
  <what-built>
Project-aware TUI with colored inline badges, grouped server list, and current-project-first search ordering.
  </what-built>
  <how-to-verify>
1. **Without projects configured** (baseline check):
   - Run `go run ./cmd/ssherpa/` from any directory
   - Verify: Server list looks the same as Phase 3 (no badges, no grouping errors)
   - Verify: Search, connect (Enter), details (Tab/i), and navigation still work

2. **With projects configured** (manually edit TOML config):
   - Create config at `~/.config/ssherpa/config.toml` with:
     ```toml
     version = 1
     backend = "sshconfig"

     [[project]]
     id = "test-project"
     name = "my-org/my-repo"
     git_remote_urls = ["https://github.com/my-org/my-repo.git"]
     server_names = ["server1", "server2"]  # Use actual SSH host names from your config
     ```
   - Run `go run ./cmd/ssherpa/`
   - Verify: Servers listed in `server_names` show a colored badge with "my-org/my-repo"
   - Verify: Those servers cluster together at the top (or grouped position)
   - Verify: Other servers appear below without badges (or with different badges)

3. **Git detection** (launch from a git repo):
   - `cd` into a git repository with an `origin` remote
   - Add a project to config whose `git_remote_urls` match the origin
   - Run `go run ./cmd/ssherpa/`
   - Verify: Current project's servers float to the top

4. **Search with project priority**:
   - Type a search query that matches servers from both current and other projects
   - Verify: Current project matches appear first, then a separator, then other matches

5. **Badge colors**: Verify badges are colored (not monochrome), and different projects get visibly different colors.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
```bash
# Build succeeds
go build ./...

# No vet warnings
go vet ./...

# All existing tests still pass
go test -race ./...

# Visual verification via checkpoint
```
</verification>

<success_criteria>
1. Every server row shows inline colored project badge(s) when assigned to projects
2. Server list grouped by project name (current project first, unassigned last)
3. Fuzzy search floats current project matches above separator
4. All Phase 3 features preserved (search, connect, navigation, history, wildcards)
5. Graceful degradation when no projects configured (identical to Phase 3 behavior)
6. Human verifies visual appearance and interaction
</success_criteria>

<output>
After completion, create `.planning/phases/04-project-detection/04-02-SUMMARY.md`
</output>
