---
phase: 08-distribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .goreleaser.yaml
  - .github/workflows/release.yml
  - scripts/install.sh
autonomous: true

must_haves:
  truths:
    - "GoReleaser produces binaries for macOS (amd64/arm64), Linux (amd64/arm64), and Windows (amd64/arm64)"
    - "Archives are .tar.gz for macOS/Linux and .zip for Windows"
    - "SHA256 checksums file is generated for all archives"
    - "Homebrew formula is auto-pushed to ssherpa/homebrew-tap on release"
    - "GitHub Actions workflow triggers on version tags (v*)"
    - "Release notes include installation instructions"
    - "Curl install script detects OS/arch and downloads correct binary"
    - "Install script verifies SHA256 checksum"
  artifacts:
    - path: ".goreleaser.yaml"
      provides: "GoReleaser v2 configuration for multi-platform builds, Homebrew tap, checksums, and release notes"
      contains: "version: 2"
    - path: ".github/workflows/release.yml"
      provides: "GitHub Actions workflow triggered by version tags"
      contains: "goreleaser/goreleaser-action@v6"
    - path: "scripts/install.sh"
      provides: "Curl install script with OS/arch detection and checksum verification"
      contains: "sha256"
  key_links:
    - from: ".github/workflows/release.yml"
      to: ".goreleaser.yaml"
      via: "goreleaser-action runs goreleaser with config"
      pattern: "goreleaser.*release"
    - from: ".goreleaser.yaml"
      to: "cmd/ssherpa"
      via: "builds.main field"
      pattern: "main:.*cmd/ssherpa"
    - from: ".goreleaser.yaml"
      to: "internal/version"
      via: "ldflags for version injection"
      pattern: "internal/version"
---

<objective>
Set up GoReleaser configuration, GitHub Actions release workflow, and curl install script for multi-platform binary distribution.

Purpose: Automated release pipeline ensures every git tag produces consistent, verified binaries across all platforms with zero manual steps. The install script provides a quick installation path for users who don't use Homebrew.

Output: GoReleaser config, GitHub Actions workflow, and install script ready for first release.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-distribution/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GoReleaser configuration</name>
  <files>.goreleaser.yaml</files>
  <action>
Create `.goreleaser.yaml` at the project root with GoReleaser v2 configuration:

```yaml
version: 2

before:
  hooks:
    - go mod tidy

builds:
  - id: ssherpa
    main: ./cmd/ssherpa
    binary: ssherpa
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ldflags:
      - -s -w
      - -X github.com/florianriquelme/ssherpa/internal/version.Version={{.Version}}
      - -X github.com/florianriquelme/ssherpa/internal/version.Commit={{.FullCommit}}
      - -X github.com/florianriquelme/ssherpa/internal/version.Date={{.Date}}
      - -X github.com/florianriquelme/ssherpa/internal/version.GoVersion={{.Env.GOVERSION}}

archives:
  - id: ssherpa
    format: tar.gz
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    format_overrides:
      - goos: windows
        format: zip

checksum:
  name_template: 'checksums.txt'
  algorithm: sha256

brews:
  - repository:
      owner: ssherpa
      name: homebrew-tap
      token: "{{ .Env.TAP_GITHUB_TOKEN }}"
    directory: Formula
    homepage: "https://github.com/florianriquelme/ssherpa"
    description: "SSH connection manager with project context and 1Password integration"
    license: "MIT"
    install: |
      bin.install "ssherpa"
    test: |
      system "#{bin}/ssherpa", "version"
    commit_msg_template: "chore: update formula for {{ .ProjectName }} version {{ .Tag }}"

changelog:
  use: github
  sort: asc
  filters:
    exclude:
      - '^docs:'
      - '^test:'
      - '^chore:'
      - 'typo'

release:
  github:
    owner: florianriquelme
    name: ssherpa
  draft: false
  prerelease: auto
  mode: append
  header: |
    ## ssherpa {{ .Tag }}

    {{ if .IsPrerelease }}This is a pre-release version.{{ end }}

  footer: |
    **Full Changelog**: https://github.com/florianriquelme/ssherpa/compare/{{ .PreviousTag }}...{{ .Tag }}

    ---

    ## Installation

    ### Homebrew
    ```sh
    brew tap ssherpa/tap
    brew install ssherpa
    ```

    ### Quick Install (macOS/Linux)
    ```sh
    curl -fsSL https://raw.githubusercontent.com/florianriquelme/ssherpa/main/scripts/install.sh | sh
    ```

    ### Direct Download
    Download the appropriate binary for your platform from the assets below and verify the checksum.
```

Key configuration choices:
- `CGO_ENABLED=0` — no CGO dependencies, ensures clean cross-compilation
- `-s -w` ldflags strip debug info for smaller binaries
- `prerelease: auto` — GoReleaser auto-detects pre-release tags (e.g., v0.1.0-alpha.1)
- `before.hooks` runs `go mod tidy` only (not `go test` — tests run in separate CI, don't want release to fail on flaky tests)
- The `brews` section uses `TAP_GITHUB_TOKEN` for cross-repo push access to the tap repository
- Archive naming: `ssherpa_0.1.0_darwin_arm64.tar.gz`
  </action>
  <verify>
`goreleaser check` validates the config (if goreleaser is installed). If not installed, verify YAML is valid with `go run github.com/goreleaser/goreleaser/v2@latest check` or just verify the file exists and is well-formed.

Alternative: `cat .goreleaser.yaml | head -5` should show `version: 2`.
  </verify>
  <done>
GoReleaser config exists at project root, targets 3 OS x 2 arch matrix, produces checksums, auto-updates Homebrew tap, and generates release notes with install instructions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions release workflow and install script</name>
  <files>.github/workflows/release.yml, scripts/install.sh</files>
  <action>
**Part A: GitHub Actions release workflow**

Create `.github/workflows/release.yml`:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          GOVERSION: ${{ steps.setup-go.outputs.go-version }}
```

Key points:
- `fetch-depth: 0` fetches full git history for changelog generation
- `go-version-file: go.mod` reads Go version from the project
- `version: "~> v2"` pins to GoReleaser v2.x
- `GITHUB_TOKEN` is auto-provided by GitHub Actions with `contents: write` permission
- `TAP_GITHUB_TOKEN` must be a Personal Access Token (PAT) with `repo` scope, stored as a repository secret — this allows pushing the formula to the separate ssherpa/homebrew-tap repo
- `GOVERSION` env var is passed through ldflags for version embedding

Note: The `GOVERSION` reference uses `steps.setup-go.outputs.go-version`. Add an `id: setup-go` to the setup-go step:
```yaml
      - id: setup-go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
```

**Part B: Curl install script**

Create `scripts/install.sh`:

```bash
#!/bin/sh
set -e

# ssherpa installer
# Usage: curl -fsSL https://raw.githubusercontent.com/florianriquelme/ssherpa/main/scripts/install.sh | sh

REPO="florianriquelme/ssherpa"

# Detect OS
detect_os() {
    os=$(uname -s)
    case "$os" in
        Linux*)  echo "linux" ;;
        Darwin*) echo "darwin" ;;
        *)       echo "Unsupported OS: $os" >&2; exit 1 ;;
    esac
}

# Detect architecture
detect_arch() {
    arch=$(uname -m)
    case "$arch" in
        x86_64)  echo "amd64" ;;
        aarch64) echo "arm64" ;;
        arm64)   echo "arm64" ;;
        *)       echo "Unsupported architecture: $arch" >&2; exit 1 ;;
    esac
}

# Get latest version from GitHub API
get_latest_version() {
    version=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
    if [ -z "$version" ]; then
        echo "Failed to determine latest version" >&2
        exit 1
    fi
    echo "$version"
}

main() {
    os=$(detect_os)
    arch=$(detect_arch)
    version="${VERSION:-$(get_latest_version)}"

    echo "Installing ssherpa v${version} for ${os}/${arch}..."

    url="https://github.com/${REPO}/releases/download/v${version}/ssherpa_${version}_${os}_${arch}.tar.gz"
    checksum_url="https://github.com/${REPO}/releases/download/v${version}/checksums.txt"

    tmpdir=$(mktemp -d)
    trap 'rm -rf "$tmpdir"' EXIT

    # Download archive and checksums
    curl -fsSL "$url" -o "${tmpdir}/ssherpa.tar.gz"
    curl -fsSL "$checksum_url" -o "${tmpdir}/checksums.txt"

    # Verify checksum
    cd "$tmpdir"
    expected=$(grep "ssherpa_${version}_${os}_${arch}.tar.gz" checksums.txt | awk '{print $1}')
    if [ -n "$expected" ]; then
        if command -v sha256sum >/dev/null 2>&1; then
            actual=$(sha256sum ssherpa.tar.gz | awk '{print $1}')
        elif command -v shasum >/dev/null 2>&1; then
            actual=$(shasum -a 256 ssherpa.tar.gz | awk '{print $1}')
        else
            echo "Warning: sha256sum/shasum not found, skipping checksum verification"
            actual="$expected"
        fi

        if [ "$actual" != "$expected" ]; then
            echo "Checksum verification failed!" >&2
            echo "Expected: $expected" >&2
            echo "Got:      $actual" >&2
            exit 1
        fi
        echo "Checksum verified."
    else
        echo "Warning: Could not find checksum for this platform, skipping verification"
    fi

    # Extract
    tar -xzf ssherpa.tar.gz

    # Install
    install_dir="${INSTALL_DIR:-/usr/local/bin}"
    if [ -w "$install_dir" ]; then
        mv ssherpa "$install_dir/ssherpa"
    else
        echo "Installing to ${install_dir} (requires sudo)..."
        sudo mv ssherpa "$install_dir/ssherpa"
    fi

    echo ""
    echo "ssherpa v${version} installed to ${install_dir}/ssherpa"
    echo "Run 'ssherpa' to get started!"
}

main
```

Make the script executable: `chmod +x scripts/install.sh`

Key design:
- Uses temp directory with trap for cleanup
- Verifies SHA256 checksum (supports both sha256sum on Linux and shasum on macOS)
- Falls back gracefully if checksum tools unavailable
- Detects if install dir is writable, only uses sudo when needed
- `VERSION` env var allows pinning: `VERSION=0.1.0 sh install.sh`
- Windows not supported in install script (users download .zip from releases)
  </action>
  <verify>
1. `.github/workflows/release.yml` exists and YAML is valid.
2. `scripts/install.sh` exists and is executable (`ls -la scripts/install.sh` shows +x).
3. `shellcheck scripts/install.sh` passes (if shellcheck is installed).
4. `sh -n scripts/install.sh` confirms no syntax errors.
  </verify>
  <done>
GitHub Actions workflow triggers on version tags and runs GoReleaser. Install script downloads the correct platform binary with checksum verification. Both files are ready for first release.
  </done>
</task>

</tasks>

<verification>
1. `.goreleaser.yaml` exists at project root with `version: 2`
2. `.github/workflows/release.yml` triggers on `v*` tags
3. `scripts/install.sh` is executable and has no syntax errors
4. GoReleaser config references correct build path (`./cmd/ssherpa`) and ldflags
5. Release notes template includes Homebrew and curl install instructions
</verification>

<success_criteria>
- GoReleaser config produces 6 platform binaries (3 OS x 2 arch)
- GitHub Actions workflow automates the full release process on tag push
- Install script works on macOS and Linux with checksum verification
- Homebrew tap gets auto-updated on release
</success_criteria>

<output>
After completion, create `.planning/phases/08-distribution/08-02-SUMMARY.md`
</output>
