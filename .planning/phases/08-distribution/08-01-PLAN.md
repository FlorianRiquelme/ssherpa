---
phase: 08-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/version/version.go
  - cmd/ssherpa/main.go
  - internal/config/config.go
autonomous: true

must_haves:
  truths:
    - "`ssherpa --version` prints version, commit, build date, Go version, and OS/arch"
    - "First run shows onboarding flow with SSH config host count and 1Password setup offer"
    - "Onboarding only shows once (persisted in config)"
    - "`ssherpa --setup` re-triggers onboarding regardless of persisted state"
    - "Onboarding is skippable at every step"
  artifacts:
    - path: "internal/version/version.go"
      provides: "Version, Commit, Date, GoVersion variables with ldflags injection"
      exports: ["Version", "Commit", "Date", "GoVersion", "Short", "Full", "Detailed"]
    - path: "cmd/ssherpa/main.go"
      provides: "CLI flag handling and onboarding orchestration"
      contains: "--version"
    - path: "internal/config/config.go"
      provides: "OnboardingDone field for persistence"
      contains: "OnboardingDone"
  key_links:
    - from: "cmd/ssherpa/main.go"
      to: "internal/version"
      via: "import and flag check"
      pattern: "version\\.Detailed"
    - from: "cmd/ssherpa/main.go"
      to: "internal/config"
      via: "OnboardingDone field read/write"
      pattern: "OnboardingDone"
---

<objective>
Add version information embedding, CLI flags (--version, --setup), and first-run onboarding flow.

Purpose: Users need `ssherpa --version` for bug reports and support. First-run onboarding guides new users through initial setup (SSH config detection + optional 1Password) before launching the TUI. This creates a polished first impression.

Output: Version package with ldflags injection, updated main.go with flag handling and onboarding, config persistence for onboarding state.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cmd/ssherpa/main.go
@internal/config/config.go
@internal/tui/wizard.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version package with ldflags injection</name>
  <files>internal/version/version.go</files>
  <action>
Create `internal/version/version.go` with the following:

1. Package-level variables for build-time injection via ldflags:
   - `Version` (default: "dev")
   - `Commit` (default: "none")
   - `Date` (default: "unknown")
   - `GoVersion` (default: "unknown")

2. Helper functions:
   - `Short() string` — returns just the version string (e.g., "0.1.0")
   - `Full() string` — returns "version (commit-short)" (e.g., "0.1.0 (abc1234)"). Handle Commit shorter than 7 chars gracefully (use full string if shorter).
   - `Detailed() string` — returns multi-line output:
     ```
     ssherpa 0.1.0
     Commit:    abc1234def890
     Built:     2026-02-15T10:00:00Z
     Go:        go1.25.0
     Platform:  darwin/arm64
     ```
   - `Platform() string` — returns `runtime.GOOS + "/" + runtime.GOARCH`

Import `fmt` and `runtime`. The ldflags path will be:
- `-X github.com/florianriquelme/ssherpa/internal/version.Version={{.Version}}`
- `-X github.com/florianriquelme/ssherpa/internal/version.Commit={{.FullCommit}}`
- `-X github.com/florianriquelme/ssherpa/internal/version.Date={{.Date}}`
- `-X github.com/florianriquelme/ssherpa/internal/version.GoVersion={{.Env.GOVERSION}}`
  </action>
  <verify>
`go build ./internal/version/` compiles without errors. `go vet ./internal/version/` passes.
  </verify>
  <done>
Version package exists with all four variables and four helper functions. Package compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI flags and first-run onboarding to main.go</name>
  <files>cmd/ssherpa/main.go, internal/config/config.go</files>
  <action>
**Part A: Config changes**

In `internal/config/config.go`, add an `OnboardingDone` field to the `Config` struct:
```go
OnboardingDone bool `toml:"onboarding_done,omitempty"` // Whether first-run onboarding has completed
```

**Part B: main.go CLI flags**

Refactor `cmd/ssherpa/main.go` to handle flags BEFORE any backend initialization:

1. Add `flag` package import and `"github.com/florianriquelme/ssherpa/internal/version"` import.

2. At the very beginning of `main()`, before config loading, parse flags:
   ```go
   versionFlag := flag.Bool("version", false, "Show version information")
   setupFlag := flag.Bool("setup", false, "Run setup wizard")
   flag.Parse()
   ```

3. If `*versionFlag`, print `version.Detailed()` and `os.Exit(0)`.

4. After config loading, determine if onboarding should run. Onboarding runs when:
   - `*setupFlag` is true (explicit re-trigger), OR
   - Config is nil or `cfg.OnboardingDone == false` (first run)

5. The onboarding flow is a NEW function `runOnboarding(cfg *config.Config, appConfigPath string, setupFlag bool) error` that:

   **Step 1: Welcome + SSH config detection**
   - Print welcome message: "Welcome to ssherpa!" (no emoji in code)
   - Count hosts in `~/.ssh/config` using the kevinburke/ssh_config library (already a dependency). Parse the file and count non-wildcard Host entries.
   - Print: "Found N SSH hosts in your config." (or "No SSH config found." if file missing/empty)
   - Print empty line for spacing.

   **Step 2: Offer 1Password setup**
   - Print: "Would you like to set up 1Password integration? [y/N] "
   - Read single line from stdin. If "y" or "Y", launch the existing `tui.NewSetupWizard(appConfigPath)` with `tea.NewProgram(wizard, tea.WithAltScreen())`.
   - If not "y", save a basic sshconfig-only config.

   **Step 3: Mark onboarding done**
   - Set `cfg.OnboardingDone = true` on the config.
   - Save config via `config.Save(cfg, appConfigPath)`.
   - Print: "Setup complete! Launching ssherpa..."
   - Print empty line.

6. After onboarding, reload config (`config.Load("")`) and continue to the existing backend initialization and TUI launch code.

7. The existing setup wizard block (`if cfg == nil || cfg.Backend == ""`) should be adjusted:
   - If onboarding was just run and set the backend, skip the wizard.
   - If onboarding was skipped (user chose N for 1Password), the backend should default to "sshconfig" and be saved.
   - The existing wizard block stays as a fallback for edge cases where config exists but backend is empty.

**Key behavioral requirements per user decisions:**
- Onboarding shows on first run only (stored in config via `OnboardingDone`)
- Skippable at every step (N at 1Password prompt just saves sshconfig backend)
- `--setup` re-triggers regardless of `OnboardingDone` state
- After onboarding, the normal TUI launches
  </action>
  <verify>
1. `go build ./cmd/ssherpa/` compiles without errors.
2. `go vet ./cmd/ssherpa/` passes.
3. Running the built binary with `--version` prints version info and exits.
4. Running with `--setup` triggers onboarding flow (interactive — verify prints welcome message and prompt).
  </verify>
  <done>
`ssherpa --version` prints multi-line version detail. `ssherpa --setup` triggers onboarding. First run (no config) triggers onboarding automatically. Subsequent runs skip onboarding and go straight to TUI. Config persists `onboarding_done = true` after completion.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` passes (all packages compile)
2. `go vet ./...` passes
3. `go test ./internal/config/...` passes (config changes don't break existing tests)
4. Built binary: `./ssherpa --version` outputs version info
5. Built binary: `./ssherpa --setup` starts onboarding flow
</verification>

<success_criteria>
- Version package provides build-time injectable version information
- `--version` flag prints detailed version info and exits
- `--setup` flag triggers onboarding wizard
- First run shows onboarding, subsequent runs skip it
- Config stores `onboarding_done` to prevent re-showing
</success_criteria>

<output>
After completion, create `.planning/phases/08-distribution/08-01-SUMMARY.md`
</output>
