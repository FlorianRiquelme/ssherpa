---
phase: 05-config-management
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - internal/tui/form.go
  - internal/tui/form_validate.go
  - internal/tui/model.go
  - internal/tui/keys.go
  - internal/tui/styles.go
  - internal/tui/messages.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "User can press 'a' to open a full-screen add form with labeled fields"
    - "User can press 'e' to open a full-screen edit form pre-filled with current server data"
    - "Form fields support Tab/Shift+Tab and j/k navigation between fields"
    - "Validation triggers on field exit (blur) with inline error messages below invalid fields"
    - "Required fields (Alias, Hostname, User) show red error when empty on blur"
    - "Hostname DNS resolution check runs on save with visual feedback"
    - "Form save writes to ~/.ssh/config using the writer from Plan 01"
    - "After successful save, server list refreshes to show the new/updated entry"
  artifacts:
    - path: "internal/tui/form.go"
      provides: "Full-screen add/edit form Bubbletea component"
      min_lines: 200
    - path: "internal/tui/form_validate.go"
      provides: "Field-level validators for SSH config form"
      exports: ["validateAlias", "validateHostname", "validateUser", "validatePort", "validateIdentityFile", "checkDNS"]
  key_links:
    - from: "internal/tui/form.go"
      to: "internal/sshconfig/writer.go"
      via: "AddHost/EditHost called on form submit"
      pattern: "sshconfig\\.AddHost|sshconfig\\.EditHost"
    - from: "internal/tui/model.go"
      to: "internal/tui/form.go"
      via: "ViewMode state machine (ViewAdd/ViewEdit)"
      pattern: "ViewAdd|ViewEdit"
    - from: "internal/tui/form.go"
      to: "internal/tui/form_validate.go"
      via: "Validators called on field blur"
      pattern: "validate"
---

<objective>
Full-screen add/edit form for SSH connections with field-level validation and DNS checking.

Purpose: Users need a polished way to add new SSH connections and edit existing ones without leaving the TUI. The form follows the existing full-screen pattern (like the detail view), presents labeled fields with Tab/j/k navigation, validates on field exit, and writes to ~/.ssh/config using the writer from Plan 01.

Output: `internal/tui/form.go` (form component), `internal/tui/form_validate.go` (validators), plus updates to model/keys/styles/messages for form integration.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-config-management/05-CONTEXT.md
@.planning/phases/05-config-management/05-RESEARCH.md
@.planning/phases/05-config-management/05-01-SUMMARY.md
@internal/tui/model.go
@internal/tui/keys.go
@internal/tui/styles.go
@internal/tui/messages.go
@internal/tui/detail_view.go
@internal/tui/picker.go
@internal/sshconfig/writer.go
@internal/sshconfig/parser.go
@cmd/ssherpa/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Form validation logic and DNS checker</name>
  <files>internal/tui/form_validate.go</files>
  <action>
Create `internal/tui/form_validate.go` with field-level validators. Each validator returns an error string (empty = valid).

**Validators:**

1. `validateAlias(value string) string` - Required, non-empty after trim. Must not contain spaces (SSH Host alias restriction). Must not start with "#". Returns "Alias is required", "Alias cannot contain spaces", etc.

2. `validateHostname(value string) string` - Required, non-empty after trim. Basic format check: must contain at least one character, no spaces. Returns "Hostname is required" if empty.

3. `validateUser(value string) string` - Required, non-empty after trim. No spaces allowed. Returns "User is required" if empty.

4. `validatePort(value string) string` - Optional (empty is valid). If non-empty: must be numeric, range 1-65535. Use strconv.Atoi. Returns "Port must be a number between 1 and 65535" if invalid.

5. `validateIdentityFile(value string) string` - Optional (empty is valid). If non-empty: expand `~` to home dir, check if file exists with `os.Stat`. Returns "File not found: <expanded path>" if not found. Does NOT return error if empty.

6. `checkDNS(hostname string) error` - Uses `net.LookupHost` with a 2-second timeout via `context.WithTimeout`. Returns nil on success, wrapped error on failure. This is called asynchronously (as a tea.Cmd) on form save, NOT on blur. The form shows a spinner during the check and displays the result.

7. `dnsCheckCmd(hostname string) tea.Cmd` - Returns a tea.Cmd that runs `checkDNS` asynchronously and sends a `dnsCheckResultMsg{hostname, err}` message.

All validators are pure functions (no I/O except validateIdentityFile and checkDNS). Validators are called synchronously on blur. DNS check is async only on save.
  </action>
  <verify>`go build ./internal/tui/...` compiles. `go vet ./internal/tui/` clean.</verify>
  <done>Six validators and one async DNS checker exist with clear error messages. All compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Full-screen add/edit form component with TUI integration</name>
  <files>internal/tui/form.go, internal/tui/model.go, internal/tui/keys.go, internal/tui/styles.go, internal/tui/messages.go</files>
  <action>
Create `internal/tui/form.go` implementing a full-screen form for add/edit SSH connections. Build this as a custom Bubbletea component (NOT using charmbracelet/huh - per research concern about Bubbletea v2 alpha compatibility, and to keep the existing pattern of hand-built components like picker.go). Use `textinput.Model` from bubbles for each field, and `textarea.Model` from bubbles for the free-text extra config field.

**Form structure (ServerForm type):**

```go
type ServerForm struct {
    mode       FormMode          // FormAdd or FormEdit
    fields     []formField       // Ordered list of form fields
    focusIndex int               // Currently focused field index
    configPath string            // SSH config file path for writing
    originalAlias string         // For edit mode: original alias (to find block)
    saving     bool              // True while DNS check in progress
    saveError  string            // Error from save attempt
    dnsError   string            // Error from DNS check (non-blocking warning)
}

type FormMode int
const (
    FormAdd FormMode = iota
    FormEdit
)

type formField struct {
    label       string
    input       textinput.Model   // For single-line fields
    textarea    textarea.Model    // For free-text (only used for ExtraConfig)
    isTextarea  bool              // True for ExtraConfig field
    required    bool              // Show required indicator
    validator   func(string) string // Validation function
    errorMsg    string            // Current validation error (empty = valid)
}
```

**Fields (in order):**
1. Alias (required) - textinput, placeholder "e.g. my-server"
2. Hostname (required) - textinput, placeholder "e.g. 192.168.1.100 or server.example.com"
3. User (required) - textinput, placeholder "e.g. root"
4. Port (optional) - textinput, placeholder "22 (default)", CharLimit 5
5. IdentityFile (optional) - textinput, placeholder "e.g. ~/.ssh/id_rsa"
6. Extra Config (optional) - textarea, placeholder "Additional SSH directives (e.g. ProxyJump bastion)"

**Key bindings within form:**
- Tab / Shift+Tab: Move to next/previous field
- j/k: Also move between fields (when not in textarea)
- Enter: On last field or when Ctrl+S is pressed, triggers save. In textarea, inserts newline.
- Ctrl+S: Save from any field
- Esc: Cancel and return to list view

**Validation flow:**
- On focus change (Tab, Shift+Tab, j, k): validate the field being LEFT (blur validation)
- Call the field's validator function
- Store error in `field.errorMsg`
- Error displays inline below the field in red/warning color

**Save flow:**
1. Validate ALL fields (not just the one being left)
2. If any required field fails validation, focus the first invalid field, do NOT save
3. If all valid, set `saving = true`, show "Checking hostname..." with spinner
4. Run `dnsCheckCmd(hostname)` async
5. On `dnsCheckResultMsg`:
   - If DNS fails: show warning but still allow save (DNS failure is informational, not blocking - the user might be on VPN or the server might not have public DNS). Set `dnsError` as a yellow warning, then proceed to write.
   - Build `HostEntry` from form fields
   - Call `sshconfig.AddHost(configPath, entry)` or `sshconfig.EditHost(configPath, originalAlias, entry)` depending on mode
   - If write error: show in `saveError`, stay on form
   - If success: send `serverSavedMsg{alias}` to model
   - Set `saving = false`

**View rendering:**
- Full-screen layout (like detail view pattern)
- Title: "Add SSH Connection" or "Edit SSH Connection: <alias>"
- Each field: label (bold, secondary color), then input, then error line (red, only if errorMsg non-empty)
- Required fields show "*" after label
- Footer: "tab: next field | ctrl+s: save | esc: cancel"
- When saving: show spinner + "Checking hostname..." instead of footer
- DNS warning: yellow text below hostname field showing DNS result

**NewServerForm(configPath string) ServerForm** - Creates form in add mode with empty fields.

**NewEditServerForm(configPath string, host sshconfig.SSHHost) ServerForm** - Creates form in edit mode, pre-fills fields from SSHHost data:
- Alias = host.Name
- Hostname = host.Hostname
- User = host.User
- Port = host.Port (empty if "22" or default)
- IdentityFile = first from host.IdentityFile slice
- ExtraConfig = remaining options from host.AllOptions (excluding HostName, User, Port, IdentityFile), formatted as "Key Value" lines

**Update model.go:**

Add two new ViewMode constants: `ViewAdd` and `ViewEdit` (after ViewDetail).

Add to Model struct:
```go
serverForm *ServerForm  // Add/edit form (nil when not showing)
```

Add key handlers in ViewList (non-search mode):
- 'a' key: creates `NewServerForm(m.configPath)`, sets `m.viewMode = ViewAdd`, stores form in `m.serverForm`
- 'e' key: gets selected hostItem, creates `NewEditServerForm(m.configPath, item.host)`, sets `m.viewMode = ViewEdit`, stores form in `m.serverForm`

Add ViewAdd/ViewEdit cases to Update and View:
- Route all messages to `m.serverForm.Update(msg)` when in form mode
- Handle `formCancelledMsg`: return to ViewList
- Handle `serverSavedMsg{alias}`: reload config (reuse `loadConfigCmd`), return to ViewList
- Handle `dnsCheckResultMsg`: forward to form

Add ViewAdd/ViewEdit to View:
- Render `m.serverForm.View()` full-screen

**Update keys.go:**

Add to KeyMap:
```go
AddServer    key.Binding  // 'a' key
EditServer   key.Binding  // 'e' key
```

Add to ShortHelp (list mode): include AddServer and EditServer bindings.

**Update styles.go:**

Add form-specific styles:
- `formTitleStyle` - bold, accent color, larger padding
- `formLabelStyle` - bold, secondary color
- `formRequiredStyle` - red/warning color for "*" indicator
- `formErrorStyle` - red/warning color, italic, for inline errors
- `formDnsWarningStyle` - amber/yellow, italic, for DNS warnings
- `formHelpStyle` - secondary color, italic (reuse pickerHelpStyle pattern)
- `formSavingStyle` - accent color for saving indicator

**Update messages.go:**

Add message types:
```go
type formCancelledMsg struct{}
type serverSavedMsg struct{ alias string }
type dnsCheckResultMsg struct{ hostname string; err error }
```
  </action>
  <verify>`go build ./...` compiles. `go vet ./...` clean. Run `go run ./cmd/ssherpa/` and press 'a' to open add form, verify fields render. Press 'e' on a server to open edit form, verify pre-filled data.</verify>
  <done>Full-screen add/edit forms work with Tab/j/k navigation, inline validation on blur, DNS check on save, and successful write to ~/.ssh/config. Server list refreshes after save.</done>
</task>

</tasks>

<verification>
1. `go build ./...` - full project compiles cleanly
2. `go vet ./...` - no warnings
3. `go test -race ./...` - all tests pass (including Plan 01 writer tests)
4. Functional test: `go run ./cmd/ssherpa/`, press 'a', fill form, save - new Host block appears in ~/.ssh/config
5. Functional test: `go run ./cmd/ssherpa/`, select server, press 'e', modify hostname, save - only that Host block changes
6. Validation test: leave required field empty, tab away - inline error appears below field
7. DNS test: enter non-existent hostname, save - warning shown but save proceeds
</verification>

<success_criteria>
- 'a' opens full-screen add form with all 6 fields (Alias, Hostname, User, Port, IdentityFile, ExtraConfig)
- 'e' opens full-screen edit form pre-filled with selected server's data
- Tab/Shift+Tab and j/k navigate between fields
- Validation triggers on field exit with red inline errors
- Required fields (Alias, Hostname, User) validated as non-empty
- Port validated as numeric 1-65535 when non-empty
- IdentityFile validated as existing file when non-empty
- DNS check runs on save with spinner, result is a non-blocking warning
- Save calls AddHost or EditHost from Plan 01 writer
- Server list reloads after successful save
- Esc cancels form and returns to list
- All existing navigation and features preserved
</success_criteria>

<output>
After completion, create `.planning/phases/05-config-management/05-02-SUMMARY.md`
</output>
