---
phase: 05-config-management
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - internal/tui/delete.go
  - internal/tui/undo.go
  - internal/tui/model.go
  - internal/tui/keys.go
  - internal/tui/messages.go
  - internal/tui/styles.go
autonomous: false

must_haves:
  truths:
    - "User can press 'd' on a server to trigger delete with type-alias confirmation"
    - "Delete confirmation requires typing the exact server alias (case-insensitive) to proceed"
    - "Deleted entry is removed from ~/.ssh/config and server list updates immediately"
    - "User can press 'u' to undo the last delete within the current session"
    - "Undo restores the deleted Host block to ~/.ssh/config and refreshes the list"
    - "Backup (.bak) is created before every delete operation"
    - "All add/edit/delete keybindings appear in the help footer"
  artifacts:
    - path: "internal/tui/delete.go"
      provides: "Delete confirmation component with type-to-confirm pattern"
      min_lines: 80
    - path: "internal/tui/undo.go"
      provides: "Session-scoped undo buffer for deleted entries"
      exports: ["UndoBuffer", "PushUndo", "PopUndo"]
  key_links:
    - from: "internal/tui/delete.go"
      to: "internal/sshconfig/writer.go"
      via: "RemoveHost called on confirmation"
      pattern: "sshconfig\\.RemoveHost"
    - from: "internal/tui/undo.go"
      to: "internal/sshconfig/writer.go"
      via: "AddHost called to restore deleted entry"
      pattern: "sshconfig\\.AddHost"
    - from: "internal/tui/model.go"
      to: "internal/tui/delete.go"
      via: "ViewDelete state machine transition on 'd' key"
      pattern: "ViewDelete"
---

<objective>
Delete confirmation with type-to-confirm pattern, session undo buffer, and full CRUD TUI integration with human verification.

Purpose: Completing the CRUD story. Delete is the most dangerous operation, so it requires the GitHub-style "type the name to confirm" pattern. The undo buffer provides a safety net within the current session. After this plan, all Phase 5 success criteria are met: add, edit, delete with validation, format preservation, and backup.

Output: `internal/tui/delete.go` (confirmation component), `internal/tui/undo.go` (undo buffer), model/keys/messages updates, plus human verification of the full CRUD flow.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-config-management/05-CONTEXT.md
@.planning/phases/05-config-management/05-RESEARCH.md
@.planning/phases/05-config-management/05-01-SUMMARY.md
@.planning/phases/05-config-management/05-02-SUMMARY.md
@internal/tui/model.go
@internal/tui/keys.go
@internal/tui/messages.go
@internal/tui/styles.go
@internal/tui/form.go
@internal/sshconfig/writer.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Undo buffer and delete confirmation component</name>
  <files>internal/tui/undo.go, internal/tui/delete.go, internal/tui/model.go, internal/tui/keys.go, internal/tui/messages.go, internal/tui/styles.go</files>
  <action>
**Create `internal/tui/undo.go`:**

Session-scoped undo buffer for deleted Host blocks.

```go
type UndoEntry struct {
    Alias       string    // The host alias that was deleted
    ConfigPath  string    // Path to the SSH config file
    RawLines    []string  // The raw text lines that were removed (from RemoveHost return value)
    DeletedAt   time.Time // When the delete occurred
}

type UndoBuffer struct {
    entries []UndoEntry
    maxSize int
}
```

- `NewUndoBuffer(maxSize int) *UndoBuffer` - Creates buffer with max 10 entries
- `(b *UndoBuffer) Push(entry UndoEntry)` - Adds entry, evicts oldest if at capacity
- `(b *UndoBuffer) Pop() (UndoEntry, bool)` - Removes and returns most recent entry. Returns false if empty.
- `(b *UndoBuffer) Len() int` - Number of entries in buffer
- `(b *UndoBuffer) IsEmpty() bool` - Whether buffer has entries

Also add `RestoreHost(configPath string, rawLines []string) error` to undo.go:
  1. Read file contents with `os.ReadFile(configPath)`
  2. Get file permissions with `os.Stat`
  3. Call `sshconfig.CreateBackup(configPath)`
  4. Append "\n" + joined raw lines (strings.Join with "\n") to content
  5. Call `sshconfig.AtomicWrite(configPath, newContent, perm)`
  This keeps undo logic co-located and avoids modifying Plan 01 files.

**Create `internal/tui/delete.go`:**

Delete confirmation component using the "type alias to confirm" pattern (mirrors GitHub repo deletion UX).

```go
type DeleteConfirm struct {
    alias       string          // Server alias to confirm
    input       textinput.Model // Text input for confirmation
    confirmed   bool            // Whether typed text matches alias
    configPath  string          // SSH config path for RemoveHost
}
```

- `NewDeleteConfirm(alias, configPath string) DeleteConfirm` - Creates the confirmation view. Input placeholder is the alias. Input has CharLimit matching alias length + 5 (some tolerance).

- `Update(msg tea.Msg) (DeleteConfirm, tea.Cmd)`:
  - On every keystroke: compare `strings.EqualFold(input.Value(), alias)` to determine if confirmed
  - Enter: if confirmed, call `sshconfig.RemoveHost(configPath, alias)`. If success, send `serverDeletedMsg{alias, removedLines}`. If error, send `deleteErrorMsg{err}`.
  - Esc: send `deleteConfirmCancelledMsg{}`

- `View() string`:
  - Full-screen overlay (centered like picker, or full-screen like detail view - Claude's discretion on which feels better)
  - Title: "Delete SSH Connection" in warning/red color
  - Warning text: "This will remove '<alias>' from your SSH config."
  - Instruction: "Type the server alias to confirm deletion:"
  - Text input with real-time feedback:
    - While typing: show typed text, no special indicator
    - When match: input border turns green/success, "Press Enter to delete" appears
    - When no match: standard border
  - Footer: "enter: delete (when confirmed) | esc: cancel"
  - The alias to type should be displayed prominently (bold, accent color) so the user knows exactly what to type

**Update `internal/tui/messages.go`:**

Add message types:
```go
type serverDeletedMsg struct {
    alias        string
    removedLines []string
}
type deleteErrorMsg struct{ err error }
type deleteConfirmCancelledMsg struct{}
type undoCompletedMsg struct{ alias string }
type undoErrorMsg struct{ err error }
```

**Update `internal/tui/model.go`:**

Add `ViewDelete` to ViewMode constants.

Add to Model struct:
```go
deleteConfirm *DeleteConfirm   // Delete confirmation (nil when not showing)
undoBuffer    *UndoBuffer      // Session-scoped undo buffer
statusMsg     string           // Temporary status message (e.g. "Deleted X, press u to undo")
```

Initialize `undoBuffer` in `New()`: `undoBuffer: NewUndoBuffer(10)`

Add key handlers in ViewList (non-search mode):
- 'd' key: gets selected hostItem, creates `NewDeleteConfirm(item.host.Name, m.configPath)`, sets `m.viewMode = ViewDelete`
- 'u' key: if `!m.undoBuffer.IsEmpty()`, pop last entry, run async command that calls `RestoreHost(entry.ConfigPath, entry.RawLines)`. On success send `undoCompletedMsg{alias}`. On error send `undoErrorMsg{err}`. If undo buffer is empty, ignore the keypress.

Add ViewDelete case to Update:
- Route messages to `deleteConfirm.Update(msg)`
- Handle `serverDeletedMsg`: push to undoBuffer (alias, configPath, removedLines, time.Now()), reload config via `loadConfigCmd`, return to ViewList, set `statusMsg = "Deleted <alias> (press 'u' to undo)"`
- Handle `deleteErrorMsg`: set `statusMsg = "Delete failed: <err>"`, return to ViewList
- Handle `deleteConfirmCancelledMsg`: return to ViewList, clear deleteConfirm
- Handle `undoCompletedMsg`: reload config, set `statusMsg = "Restored <alias>"`
- Handle `undoErrorMsg`: set `statusMsg = "Undo failed: <err>"`

Add ViewDelete case to View:
- Render `deleteConfirm.View()` centered using lipgloss.Place (same pattern as picker overlay)

Update View for ViewList: if `statusMsg` is non-empty, render it below the help footer in accent/undo style. Clear it on next key press (set statusMsg = "" at start of any key handler in ViewList).

**Update `internal/tui/keys.go`:**

Add to KeyMap:
```go
DeleteServer key.Binding  // 'd' key, help "d", label "delete"
Undo         key.Binding  // 'u' key, help "u", label "undo"
```

Update ShortHelp to include the most important CRUD keys. Given space constraints, use this grouping:
- ShortHelp: Connect, Details, Search, AddServer, EditServer, DeleteServer, Quit
- FullHelp: add Undo and AssignProject in additional group

**Update `internal/tui/styles.go`:**

Add delete-specific styles:
- `deleteWarningStyle` - Red/warning color, bold, for "Delete SSH Connection" title
- `deleteInstructionStyle` - Secondary color for instruction text
- `deleteConfirmedStyle` - Green/success color for confirmed state border
- `undoStatusStyle` - Accent color for "press 'u' to undo" flash message
  </action>
  <verify>`go build ./...` compiles. `go vet ./...` clean. `go test -race ./...` all pass. Run `go run ./cmd/sshjesus/`, press 'd' on a server, verify confirmation prompt appears.</verify>
  <done>Delete with type-to-confirm works, undo buffer stores deleted entries, 'u' restores last deleted entry, all keybindings appear in help.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete CRUD workflow</name>
  <files></files>
  <action>
Human verification checkpoint. No code changes -- this task verifies the complete CRUD workflow built across Plans 01, 02, and 03.

Present the user with the verification steps below. Wait for their "approved" or issue description before proceeding.
  </action>
  <verify>
Run `go run ./cmd/sshjesus/` and test the complete CRUD flow:

**1. Add a new server:**
  - Press 'a' to open add form
  - Verify all 6 fields appear (Alias*, Hostname*, User*, Port, IdentityFile, ExtraConfig)
  - Tab between fields - verify navigation works
  - Leave Alias empty, tab away - verify red "Alias is required" error appears
  - Fill: Alias="test-crud", Hostname="192.168.1.999", User="testuser", Port="2222"
  - Press Ctrl+S to save
  - Verify DNS warning appears (non-existent host) but save proceeds
  - Verify server list refreshes and "test-crud" appears
  - Verify `~/.ssh/config` has the new Host block at the end
  - Verify `~/.ssh/config.bak` exists

**2. Edit the server:**
  - Select "test-crud" in list
  - Press 'e' to open edit form
  - Verify fields are pre-filled with Hostname, User, Port
  - Change Hostname to "10.0.0.1"
  - Press Ctrl+S to save
  - Verify server list refreshes with updated hostname
  - Verify `~/.ssh/config` shows updated HostName in test-crud block
  - Verify other Host blocks are UNCHANGED (comments, indentation, blank lines preserved)

**3. Delete the server:**
  - Select "test-crud" in list
  - Press 'd' to open delete confirmation
  - Verify it asks to type "test-crud" to confirm
  - Type "test-cru" (incomplete) - verify Enter does not delete
  - Type "test-crud" - verify confirmation indicator appears
  - Press Enter to delete
  - Verify "test-crud" is gone from list
  - Verify `~/.ssh/config` no longer has the Host block
  - Verify status shows "press 'u' to undo"

**4. Undo the delete:**
  - Press 'u' to undo
  - Verify "test-crud" reappears in the list
  - Verify `~/.ssh/config` has the Host block again

**5. Verify no regressions:**
  - Press '/' to search - verify search still works
  - Press Enter on a server - verify SSH connect still works (Ctrl+C to cancel)
  - Press 'p' to assign project - verify project picker still works
  - Help footer shows all new keybindings

**6. Clean up:**
  - Delete "test-crud" again using 'd' flow (to leave config clean)
  </verify>
  <done>User approves the complete CRUD workflow: add, edit, delete with confirmation, undo, validation, backup, and no regressions.</done>
</task>

</tasks>

<verification>
1. `go build ./...` - full project compiles
2. `go vet ./...` - no warnings
3. `go test -race ./...` - all tests pass
4. Human verification of complete CRUD workflow (Task 2)
5. Verify ~/.ssh/config integrity after all operations
6. Verify all existing Phase 3/4 features (search, connect, project picker) still work
</verification>

<success_criteria>
- 'd' opens delete confirmation with type-to-confirm pattern
- Typing the exact alias (case-insensitive) enables the delete button
- Deleted entry is removed from ~/.ssh/config
- 'u' undoes the last delete, restoring the entry
- Undo buffer holds up to 10 entries, session-scoped
- Backup created before every delete
- All keybindings (a/e/d/u) appear in help footer
- No regressions to existing search, connect, project picker features
- Human verification passes for complete CRUD workflow
</success_criteria>

<output>
After completion, create `.planning/phases/05-config-management/05-03-SUMMARY.md`
</output>
