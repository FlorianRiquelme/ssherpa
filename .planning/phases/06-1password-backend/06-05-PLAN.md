---
phase: 06-1password-backend
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - internal/tui/wizard.go
  - internal/tui/wizard_test.go
  - internal/tui/migration.go
  - internal/tui/model.go
  - internal/tui/messages.go
  - internal/tui/keys.go
  - internal/config/config.go
  - cmd/sshjesus/main.go
autonomous: false

must_haves:
  truths:
    - "First launch shows interactive setup wizard for backend selection"
    - "Setup wizard walks through 1Password configuration step-by-step"
    - "Migration wizard scans for existing SSH/Server items in 1Password without sshjesus tag"
    - "User can select which items to migrate and fill in missing fields"
    - "Setup completes with saved config and 1Password backend active"
  artifacts:
    - path: "internal/tui/wizard.go"
      provides: "First-launch backend selection and 1Password setup wizard"
      contains: "SetupWizard"
    - path: "internal/tui/migration.go"
      provides: "Migration wizard for existing 1Password SSH items"
      contains: "MigrationWizard"
  key_links:
    - from: "internal/tui/wizard.go"
      to: "internal/config/config.go"
      via: "saves backend choice and 1Password config to TOML"
      pattern: "config\\.Save"
    - from: "internal/tui/migration.go"
      to: "internal/backend/onepassword/backend.go"
      via: "tags existing items with sshjesus tag"
      pattern: "onepassword"
    - from: "cmd/sshjesus/main.go"
      to: "internal/tui/wizard.go"
      via: "shows wizard when config.Backend is empty"
      pattern: "wizard"
---

<objective>
Implement setup wizard and migration wizard: first-launch experience for backend selection, step-by-step 1Password configuration, and migration of existing unstructured SSH items to sshjesus format.

Purpose: Users need a guided onboarding experience to configure the 1Password backend. Teams with existing unstructured SSH items in 1Password need a migration path to bring those items under sshjesus management.

Output: Interactive setup wizard and migration wizard, integrated into the TUI launch flow.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-1password-backend/06-RESEARCH.md
@.planning/phases/06-1password-backend/06-01-SUMMARY.md
@.planning/phases/06-1password-backend/06-04-SUMMARY.md
@internal/tui/model.go
@internal/tui/form.go
@internal/config/config.go
@cmd/sshjesus/main.go
@internal/backend/onepassword/backend.go
@internal/backend/onepassword/client.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup wizard for backend selection and 1Password configuration</name>
  <files>
    internal/tui/wizard.go
    internal/tui/messages.go
    internal/tui/keys.go
    internal/config/config.go
    cmd/sshjesus/main.go
  </files>
  <action>
**Create `internal/tui/wizard.go`:**

The setup wizard is a separate Bubbletea model that runs BEFORE the main TUI when `config.Backend == ""` (no backend configured).

Wizard steps (each is a screen):

**Step 1: Welcome + Backend Selection**
```
Welcome to sshjesus!

Choose your backend:

  > SSH Config only      Uses ~/.ssh/config (already working)
    1Password            Store servers in 1Password for team sharing
    Both                 SSH Config + 1Password (recommended for teams)

Use j/k to navigate, Enter to select
```

If user selects "SSH Config only":
- Save config with `Backend: "sshconfig"`
- Exit wizard, launch main TUI

**Step 2: 1Password Setup (if selected)**
```
1Password Setup

Step 1: Checking for 1Password desktop app...
  [spinner] Detecting 1Password...

If detected:
  ✓ 1Password desktop app found

Step 2: Enter your 1Password account name
  (The email or account ID shown at top-left of 1Password sidebar)

  Account: [text input]

Step 3: Testing connection...
  [spinner] Connecting to 1Password...

If successful:
  ✓ Connected! Found {N} vaults

  Press Enter to continue
```

If 1Password not detected:
```
  ✗ 1Password desktop app not found

  To use the 1Password backend:
  1. Install 1Password 8 from https://1password.com
  2. Enable the desktop app integration in 1Password settings
  3. Re-run sshjesus

  Press Enter to use SSH Config only, or Esc to quit
```

**Step 3: Offer Migration** (only if 1Password connected and existing items found)
```
Existing Items Found

We found {N} SSH/Server items in your 1Password vaults
that are not yet managed by sshjesus.

  > Run migration wizard    Tag existing items for sshjesus
    Skip for now            You can migrate later with 'sshjesus migrate'

Use j/k to navigate, Enter to select
```

**Step 4: Summary**
```
Setup Complete!

Backend: {selected backend}
{if 1Password: Account: {account name}}
{if migrated: Migrated: {N} items}

Config saved to: {config path}

Press Enter to start sshjesus
```

Implement as a Bubbletea model:
```go
type SetupWizard struct {
    step        int
    backendChoice string // "sshconfig", "onepassword", "both"
    accountName  string
    // ... text inputs, spinners, status
}
```

Follow the hand-built form pattern from Phase 05-02 (no external form library).

**Update `internal/config/config.go`:**
- Add `MigrationDone bool` field to track whether migration has been offered

**Update `cmd/sshjesus/main.go`:**
- Before creating main TUI, check if `cfg.Backend == ""` or `cfg == nil`
- If so, run the setup wizard as a separate `tea.NewProgram(wizard)` FIRST
- Wizard saves config to disk
- After wizard exits, reload config and launch main TUI

**Update `internal/tui/messages.go`:**
```go
type wizardCompleteMsg struct {
    backendChoice string
    accountName   string
    runMigration  bool
}
```

**Update `internal/tui/keys.go`:**
- Add wizard-specific key bindings if needed (likely reuse existing j/k/Enter/Esc)
  </action>
  <verify>
Run `go build ./...` — project compiles.
Verify wizard model exists: `grep "SetupWizard" internal/tui/wizard.go`
Verify main.go checks for empty backend: `grep "Backend.*==" cmd/sshjesus/main.go`
  </verify>
  <done>
Setup wizard guides users through backend selection and 1Password configuration. Wizard detects 1Password app, tests connection, and saves config. main.go runs wizard before main TUI when backend not configured.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migration wizard for existing 1Password SSH items</name>
  <files>
    internal/tui/migration.go
    internal/tui/model.go
  </files>
  <action>
**Create `internal/tui/migration.go`:**

Migration wizard scans all vaults for SSH/Server category items WITHOUT the "sshjesus" tag and offers to tag them.

```go
type MigrationWizard struct {
    client    onepassword.Client   // SDK client
    items     []MigrationCandidate // Discovered items
    selected  map[int]bool         // Toggle selection
    cursor    int
    step      int                  // scanning, selecting, migrating, done
    spinner   spinner.Model
    results   MigrationResults
}

type MigrationCandidate struct {
    Item      onepassword.Item
    VaultName string
    HasHostname bool  // Whether hostname field exists
    HasUser     bool  // Whether user field exists
    Complete    bool  // Has all required fields
}

type MigrationResults struct {
    Migrated int
    Skipped  int
    Errors   []string
}
```

**Step 1: Scan** — search all vaults for items:
- Category "Server" or "SSH" (or items with SSH-related field names like "hostname", "host")
- WITHOUT "sshjesus" tag (already managed items are excluded)
- Show spinner during scan

**Step 2: Select** — show list with checkboxes:
```
Migration: {N} items found

  [x] prod-web-01      (Private vault)     ✓ Complete
  [x] staging-db       (Customer-A vault)  ⚠ Missing user
  [ ] dev-jumphost     (Shared vault)      ✓ Complete
  [ ] old-server       (Personal vault)    ✗ Missing hostname

  Space: toggle, a: select all, n: deselect all
  Enter: migrate selected, Esc: skip

  {selected_count}/{total_count} selected
```

Completeness indicators:
- "Complete": has hostname + user (minimum required fields)
- "Missing user": has hostname but no user field
- "Missing hostname": no hostname field found

**Step 3: Migrate** — for each selected item:
1. If complete: add "sshjesus" tag, ensure field labels match expected format (hostname, user, port, etc.)
2. If incomplete: show inline form to fill missing required fields (hostname/user)
3. Call `client.UpdateItem()` to save tagged item
4. Show progress: "Migrating... {N}/{total}"

**Step 4: Results**
```
Migration Complete

  Migrated:  {N} items
  Skipped:   {M} items
  Errors:    {E} items

  Press Enter to continue
```

Track migration state:
- Save `MigrationDone: true` in config after migration runs (or is skipped)
- Don't re-offer migration on subsequent launches

**Integration with Model:**
- Add `ViewMigration` to ViewMode enum if migration runs within the main TUI
- OR run migration as a separate `tea.Program` (simpler, like the wizard)
- Choose: run as separate program (consistent with wizard pattern)
  </action>
  <verify>
Run `go build ./...` — project compiles.
Verify migration model exists: `grep "MigrationWizard" internal/tui/migration.go`
Verify scan logic: `grep "sshjesus" internal/tui/migration.go` shows tag filtering.
  </verify>
  <done>
Migration wizard scans 1Password vaults for unmanaged SSH items. Users select which items to migrate with visibility into completeness. Selected items get tagged with "sshjesus" and field labels normalized. Migration state tracked in config to avoid re-offering.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end 1Password backend verification</name>
  <files>cmd/sshjesus/main.go</files>
  <action>
This is a human verification checkpoint. No code changes needed.

What was built (Plans 06-01 through 06-05):
1. 1Password backend adapter (Backend + Writer interfaces)
2. Sync engine (SSH include file + TOML cache + conflict detection)
3. Offline fallback with auto-recovery polling
4. Multi-backend aggregator with priority-based dedup
5. TUI status bar for 1Password availability
6. Setup wizard for first-launch configuration
7. Migration wizard for existing SSH items

Prerequisites for testing:
- 1Password desktop app installed and unlocked
- At least one vault accessible

Test 1 - First Launch (Setup Wizard):
1. Delete or rename sshjesus config: rm ~/.config/sshjesus/config.toml
2. Run: go run ./cmd/sshjesus/
3. Verify setup wizard appears with backend options
4. Select "Both" (SSH Config + 1Password)
5. Enter your 1Password account name when prompted
6. Verify connection test succeeds
7. Skip or run migration wizard

Test 2 - Server List (Multi-Backend):
1. Launch sshjesus (config now saved)
2. Verify servers from ~/.ssh/config appear in list
3. If any 1Password items are tagged "sshjesus", verify they also appear
4. Verify no visual distinction between backends (servers look the same)
5. If a server exists in both, verify 1Password version takes priority

Test 3 - Status Bar:
1. With sshjesus running, lock 1Password (Cmd+L or timeout)
2. Verify warning bar appears: "1Password is locked..."
3. Unlock 1Password
4. Verify warning bar disappears within ~5 seconds (polling interval)

Test 4 - SSH Include File:
1. Check ~/.ssh/sshjesus_config exists with correct Host blocks
2. Check ~/.ssh/config has Include directive at top
3. Try: ssh {1password-server-alias} from terminal (should connect via include file)

Test 5 - Offline Fallback:
1. Quit 1Password entirely
2. Launch sshjesus
3. Verify cached servers still appear (from TOML cache)
4. Verify warning bar shows "1Password is not running"
5. Start 1Password and unlock
6. Verify servers reload automatically within 5 seconds

Test 6 - CRUD via 1Password:
1. In sshjesus, press 'a' to add a new server
2. Fill in fields and save
3. Verify the new server appears in 1Password (check via 1Password app)
4. Verify the new server has "sshjesus" tag
5. Edit the server (press 'e'), change hostname, save
6. Verify change reflected in 1Password
7. Delete the server (press 'd'), confirm
8. Verify server removed from 1Password

Resume signal: Type "approved" if all tests pass, or describe which tests failed and what happened.
  </action>
  <verify>All 6 test scenarios pass with real 1Password desktop app.</verify>
  <done>End-to-end 1Password backend verified: setup wizard, multi-backend list, status bar, SSH include file, offline fallback, and CRUD operations all work with real 1Password.</done>
</task>

</tasks>

<verification>
1. `go build ./...` — project compiles
2. `go test ./... -count=1` — all tests pass
3. `go vet ./...` — no warnings
4. Setup wizard runs when no config exists
5. Migration wizard discovers and tags items
6. End-to-end flow works with real 1Password (human verification)
</verification>

<success_criteria>
- First-launch wizard guides users through backend selection
- 1Password setup detects app, tests connection, saves config
- Migration wizard finds untagged SSH items and tags them
- End-to-end flow from 1Password to TUI works with real desktop app
- Status bar appears/disappears based on 1Password availability
- CRUD operations reflected in 1Password items
- SSH include file enables standard ssh commands
</success_criteria>

<output>
After completion, create `.planning/phases/06-1password-backend/06-05-SUMMARY.md`
</output>
