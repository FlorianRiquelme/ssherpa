---
phase: 06-1password-backend
plan: 02
subsystem: sync
tags: [sync-engine, ssh-config, toml-cache, conflict-detection, atomic-writes]

dependency_graph:
  requires:
    - "06-01 (1Password backend adapter)"
    - "internal/domain/server.go (Server with RemoteProjectPath and VaultID)"
    - "internal/sshconfig/parser.go (SSH config parsing)"
  provides:
    - "WriteSSHIncludeFile (SSH Host block generation)"
    - "EnsureIncludeDirective (Include directive management)"
    - "WriteTOMLCache / ReadTOMLCache (offline cache)"
    - "DetectConflicts (alias conflict detection)"
  affects:
    - "Future sync commands (will use these functions)"
    - "Backend implementations (can use TOML cache)"

tech_stack:
  added:
    - "renameio/v2 (atomic file writes)"
    - "BurntSushi/toml (TOML serialization)"
  patterns:
    - "TDD with RED-GREEN-REFACTOR cycles"
    - "Atomic writes for all file operations"
    - "Temp directories for test isolation"
    - "Case-insensitive string matching"

key_files:
  created:
    - path: "internal/sync/ssh_include.go"
      lines: 169
      exports: ["WriteSSHIncludeFile", "EnsureIncludeDirective"]
    - path: "internal/sync/ssh_include_test.go"
      lines: 386
      tests: 10
    - path: "internal/sync/conflict.go"
      lines: 99
      exports: ["DetectConflicts", "Conflict"]
    - path: "internal/sync/conflict_test.go"
      lines: 361
      tests: 8
    - path: "internal/sync/toml_cache_test.go"
      lines: 161
      tests: 5
  modified:
    - path: "internal/sync/toml_cache.go"
      note: "Already existed from 06-03, verified compatibility"

decisions:
  - decision: "Prepend Include directive to ~/.ssh/config (not append)"
    rationale: "SSH config is first-match-wins. If 'Host *' appears before Include, 1Password servers won't match."
    alternatives: ["Append (would break with Host * patterns)"]
    choice: "Prepend with comment header"

  - decision: "ForwardAgent detected via tags or notes convention"
    rationale: "1Password doesn't have a standard ForwardAgent field, so we use a convention (tag or note containing 'forwardagent')"
    alternatives: ["Hard-code for specific servers", "Separate config file"]
    choice: "Tag/note convention for flexibility"

  - decision: "Exclude ssherpa_config entries from conflict detection"
    rationale: "Conflicts with ssherpa-generated include file aren't real conflicts - they're expected"
    alternatives: ["Report all conflicts", "Manual exclusion list"]
    choice: "Auto-detect by SourceFile path containing 'ssherpa_config'"

  - decision: "1Password always wins conflicts (per requirement)"
    rationale: "Design requirement - 1Password is source of truth for servers"
    alternatives: ["User choice", "Merge strategies"]
    choice: "1Password wins, store as Winner='onepassword'"

metrics:
  duration_seconds: 351
  completed_at: "2026-02-14T13:30:14Z"
  tasks_completed: 2
  files_created: 5
  files_modified: 0
  tests_added: 23
  tests_passing: 23
  lines_added: ~1176
  commits: 2
---

# Phase 06 Plan 02: Sync Engine - SSH Include Files, TOML Cache, and Conflict Detection

**One-liner:** SSH include file generation, Include directive management, TOML cache for ssherpa-specific fields, and conflict detection with 1Password-wins semantics.

## What Was Built

Implemented the sync engine that writes 1Password servers to local storage:

1. **SSH Include File Writer** (`ssh_include.go`):
   - `WriteSSHIncludeFile`: Generates valid SSH Host blocks from domain.Server list
   - Header with timestamp and "Generated by ssherpa" warning
   - Optional fields (Port, IdentityFile, ProxyJump) only included when non-default
   - ForwardAgent detected via "forwardagent" tag or note mention
   - Atomic writes via renameio with 0600 permissions

2. **Include Directive Management** (`ssh_include.go`):
   - `EnsureIncludeDirective`: Prepends Include directive to ~/.ssh/config
   - Case-insensitive duplicate detection (idempotent)
   - Creates file if doesn't exist
   - Prepends (not appends) for first-match-wins SSH config semantics

3. **TOML Cache** (`toml_cache.go`):
   - `WriteTOMLCache`: Serializes servers with ssherpa-specific fields
   - `ReadTOMLCache`: Deserializes for offline fallback
   - Preserves RemoteProjectPath, ProjectIDs, VaultID, Tags, Notes
   - Includes LastSync timestamp for staleness detection

4. **Conflict Detection** (`conflict.go`):
   - `DetectConflicts`: Finds duplicate aliases between 1Password and SSH config
   - Case-insensitive matching (Prod-Web == prod-web)
   - Excludes ssherpa_config entries (auto-detect by SourceFile path)
   - Returns Conflict structs with Winner="onepassword"

## Test Coverage

23 tests across 3 test files, all passing:

**SSH Include Tests** (10 tests):
- Full server with all fields → correct Host block
- Minimal server (port 22) → no Port line
- Multiple servers → blank line separators
- Empty server list → header only
- File permissions → 0600 verified
- New SSH config file → created with Include
- Existing SSH config → Include prepended before content
- Include already present → no-op
- Idempotent → calling twice doesn't duplicate
- Case-insensitive → "include" matches "Include"

**TOML Cache Tests** (5 tests):
- Round-trip → all fields preserved
- Non-existent file → error
- RemoteProjectPath → ssherpa-specific field survives
- Empty server list → valid TOML with empty array
- Timestamp → LastSync written to file

**Conflict Detection Tests** (8 tests):
- No conflicts → different aliases return empty
- One conflict → same alias detected
- Case-insensitive → Prod-Web matches prod-web
- Exclude ssherpa_config → entries from include file not conflicts
- Multiple conflicts → two duplicates detected
- Empty SSH config → no conflicts
- Non-existent SSH config → handled gracefully

## Technical Highlights

**Atomic Writes:**
- All file operations use `renameio.WriteFile` for atomicity
- Write to temp file, then atomic rename
- Prevents partial writes if process interrupted

**First-Match-Wins SSH Config:**
- Include directive prepended (not appended) to ~/.ssh/config
- Critical for proper SSH config resolution
- If "Host *" appears before Include, 1Password servers won't match

**Case-Insensitive Matching:**
- Conflict detection uses `strings.ToLower` for keys
- Matches SSH config behavior (Host patterns are case-insensitive)

**Test Isolation:**
- All tests use `t.TempDir()` for temp directories
- Never touch real ~/.ssh files
- Prevents test pollution and enables parallel execution

## Deviations from Plan

None - plan executed exactly as written.

## Integration Points

**Consumed by (future plans):**
- Sync command will call `WriteSSHIncludeFile` + `EnsureIncludeDirective`
- Backend implementations can use `WriteTOMLCache` for offline fallback
- Conflict detection will warn users before overwriting SSH config entries

**Dependencies used:**
- `internal/domain/server.go` - Server struct with all fields
- `internal/sshconfig/parser.go` - ParseSSHConfig for conflict detection
- `renameio/v2` - Atomic file writes
- `BurntSushi/toml` - TOML encoding/decoding

## Files Created

```
internal/sync/
├── ssh_include.go          (169 lines, 2 exports)
├── ssh_include_test.go     (386 lines, 10 tests)
├── conflict.go             (99 lines, 2 exports)
├── conflict_test.go        (361 lines, 8 tests)
└── toml_cache_test.go      (161 lines, 5 tests)
```

Note: `toml_cache.go` was already created in commit 07c8faf (from plan 06-03 work done earlier), verified compatible.

## Commits

1. **ec875c3** - feat(06-02): implement SSH include file writer and Include directive management
   - WriteSSHIncludeFile with header and optional fields
   - EnsureIncludeDirective with prepend and idempotent behavior
   - 10 tests covering all scenarios

2. **7b61a03** - feat(06-02): implement conflict detection and TOML cache tests
   - DetectConflicts with case-insensitive matching
   - TOML cache round-trip tests
   - 13 tests for conflict scenarios and cache preservation

## Verification

All success criteria met:

- [x] SSH include file contains valid Host blocks for all 1Password servers
- [x] Include directive prepended to ~/.ssh/config (not appended)
- [x] TOML cache preserves RemoteProjectPath and ProjectIDs through round-trip
- [x] Conflicts detected by alias name (case-insensitive), 1Password always wins
- [x] All file operations use atomic writes (renameio)
- [x] Tests use temp directories, never touch real SSH config

Build verification:
```bash
go test ./internal/sync/... -v -count=1  # 23/23 pass
go build ./...                            # Clean build
go vet ./internal/sync/...                # No warnings
```

## Next Steps

With sync engine complete, next plans can:
1. Implement sync command that calls these functions
2. Add background sync with conflict warnings
3. Implement cache staleness detection using LastSync timestamp
4. Add sync status display in TUI

## Self-Check: PASSED

**Files created verified:**
```bash
✓ internal/sync/ssh_include.go exists (169 lines)
✓ internal/sync/ssh_include_test.go exists (386 lines)
✓ internal/sync/conflict.go exists (99 lines)
✓ internal/sync/conflict_test.go exists (361 lines)
✓ internal/sync/toml_cache_test.go exists (161 lines)
✓ internal/sync/toml_cache.go exists (already from 07c8faf)
```

**Commits verified:**
```bash
✓ ec875c3 exists (Task 1 - SSH include)
✓ 7b61a03 exists (Task 2 - conflict detection)
```

**Tests verified:**
```bash
✓ 23 tests passing in ./internal/sync/...
✓ go build ./... succeeds
✓ go vet ./internal/sync/... clean
```
