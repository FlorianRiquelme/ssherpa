---
phase: 06-1password-backend
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/domain/server.go
  - internal/backend/onepassword/client.go
  - internal/backend/onepassword/client_test.go
  - internal/backend/onepassword/mapping.go
  - internal/backend/onepassword/mapping_test.go
  - internal/backend/onepassword/backend.go
  - internal/backend/onepassword/backend_test.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "1Password backend adapter implements backend.Backend and backend.Writer interfaces"
    - "Server configs convert losslessly between 1Password items and domain.Server"
    - "Tag-based discovery finds items with 'sshjesus' tag across all accessible vaults"
    - "SDK client initializes with desktop app integration and handles auth errors"
    - "domain.Server includes RemoteProjectPath and VaultID fields"
  artifacts:
    - path: "internal/domain/server.go"
      provides: "Extended Server domain model with RemoteProjectPath and VaultID"
      contains: "RemoteProjectPath"
    - path: "internal/backend/onepassword/client.go"
      provides: "SDK wrapper for 1Password desktop app integration"
      contains: "NewDesktopAppClient"
    - path: "internal/backend/onepassword/mapping.go"
      provides: "Item-to-Server and Server-to-Item conversion functions"
      exports: ["ItemToServer", "ServerToItem"]
    - path: "internal/backend/onepassword/backend.go"
      provides: "Backend and Writer interface implementation"
      contains: "ListServers"
  key_links:
    - from: "internal/backend/onepassword/backend.go"
      to: "internal/backend/backend.go"
      via: "implements Backend + Writer interfaces"
      pattern: "var _ backend\\.Backend"
    - from: "internal/backend/onepassword/mapping.go"
      to: "internal/domain/server.go"
      via: "converts between 1Password items and domain.Server"
      pattern: "domain\\.Server"
    - from: "internal/backend/onepassword/backend.go"
      to: "internal/backend/onepassword/client.go"
      via: "uses SDK client for vault/item operations"
      pattern: "b\\.client"
---

<objective>
Implement the core 1Password backend adapter: SDK client wrapper, item-to-server mapping, and full Backend + Writer interface implementation with tag-based discovery.

Purpose: This is the foundation for all 1Password functionality. The backend adapter enables reading/writing server configs to 1Password items, which is the prerequisite for sync, offline fallback, and TUI integration.

Output: Working 1Password backend that can list/get/create/update/delete servers via 1Password SDK, fully tested with mock client.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-1password-backend/06-RESEARCH.md
@internal/backend/backend.go
@internal/domain/server.go
@internal/domain/project.go
@internal/errors/errors.go
@internal/sshconfig/backend.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain model extensions + SDK client wrapper + item mapping</name>
  <files>
    internal/domain/server.go
    internal/backend/onepassword/client.go
    internal/backend/onepassword/client_test.go
    internal/backend/onepassword/mapping.go
    internal/backend/onepassword/mapping_test.go
    go.mod
    go.sum
  </files>
  <action>
**Step 1: Extend domain.Server** — Add two new fields to `internal/domain/server.go`:
- `RemoteProjectPath string` — remote path on server for `ssh user@host -t 'cd /path && $SHELL'`
- `VaultID string` — 1Password vault ID for write operations (empty for non-1P servers)

These fields are storage-agnostic (no struct tags), consistent with existing pattern.

**Step 2: Add 1Password SDK dependency:**
```bash
go get github.com/1Password/onepassword-sdk-go@v0.4.0-beta.2
```

**Step 3: Create SDK client wrapper** (`internal/backend/onepassword/client.go`):

Define a `Client` interface that wraps the SDK operations needed by sshjesus. This enables testing with mock implementations:

```go
// Client abstracts 1Password SDK operations for testability.
type Client interface {
    ListVaults(ctx context.Context) ([]Vault, error)
    ListItems(ctx context.Context, vaultID string) ([]Item, error)
    GetItem(ctx context.Context, vaultID, itemID string) (*Item, error)
    CreateItem(ctx context.Context, item *Item) (*Item, error)
    UpdateItem(ctx context.Context, item *Item) (*Item, error)
    DeleteItem(ctx context.Context, vaultID, itemID string) error
    Close() error
}
```

Define simplified `Vault`, `Item`, `ItemField` structs that mirror 1Password SDK types but are owned by sshjesus (avoids SDK type leakage into domain):
- `Vault`: ID, Name
- `Item`: ID, Title, VaultID, Category, Tags, Fields
- `ItemField`: Label, Value, FieldType (text/concealed)

Implement `SDKClient` that wraps the real 1Password SDK:
- `NewDesktopAppClient(accountName string) (*SDKClient, error)` — uses `onepassword.WithDesktopAppIntegration(accountName)` and `onepassword.WithIntegrationInfo("sshjesus", "v0.1.0")`
- `NewServiceAccountClient(token string) (*SDKClient, error)` — uses `onepassword.WithServiceAccountToken(token)` as fallback
- Each method wraps SDK iterator patterns into slice returns
- All SDK calls use `context.WithTimeout` (5-second timeout)

Also implement `MockClient` in `client_test.go` for testing:
- In-memory vault/item storage
- Configurable error injection
- Implements `Client` interface

**Step 4: Create item mapping** (`internal/backend/onepassword/mapping.go`):

1Password item structure (per research):
- Category: Server
- Title: Server alias (DisplayName)
- Tags: includes "sshjesus"
- Fields by label: "hostname", "user", "port", "identity_file", "remote_project_path", "project_tags", "proxy_jump", "forward_agent", "extra_config"

Implement:
- `ItemToServer(item *Item) (*domain.Server, error)` — extract fields by label (case-insensitive), validate hostname+user required, default port 22, split project_tags by comma into ProjectIDs
- `ServerToItem(server *domain.Server, vaultID string) *Item` — build item with all fields, ensure "sshjesus" tag present (deduplicated), category "server"
- `HasSshjesusTag(tags []string) bool` — case-insensitive check for "sshjesus" tag

**Step 5: TDD tests** for mapping (`mapping_test.go`):
- RED: Test `ItemToServer` with complete item (all fields) -> expected server
- RED: Test `ItemToServer` with minimal item (hostname+user only) -> default port 22, empty optional fields
- RED: Test `ItemToServer` with missing hostname -> error
- RED: Test `ItemToServer` with missing user -> error
- RED: Test `ServerToItem` round-trip (server -> item -> server should be lossless)
- RED: Test `HasSshjesusTag` case-insensitive ("SSHJESUS", "SshJesus", "sshjesus")
- GREEN: Implement to pass
- REFACTOR: Clean up

Use testify assertions (project convention).
  </action>
  <verify>
Run `go test ./internal/backend/onepassword/... -v -run TestMapping` — all mapping tests pass.
Run `go build ./...` — project compiles with new SDK dependency.
Check domain.Server has RemoteProjectPath and VaultID fields: `grep -n "RemoteProjectPath\|VaultID" internal/domain/server.go`
  </verify>
  <done>
domain.Server extended with RemoteProjectPath and VaultID. SDK client wrapper exists with Client interface and MockClient. Item-to-Server mapping is bidirectional and lossless. All mapping tests pass with 100% coverage of mapping.go.
  </done>
</task>

<task type="auto">
  <name>Task 2: 1Password backend adapter with Backend + Writer interfaces</name>
  <files>
    internal/backend/onepassword/backend.go
    internal/backend/onepassword/backend_test.go
  </files>
  <action>
**Create the backend adapter** (`internal/backend/onepassword/backend.go`):

```go
type Backend struct {
    client  Client              // SDK client (real or mock)
    mu      sync.RWMutex        // Protects cached servers
    servers []*domain.Server    // Cached servers from last sync
    closed  bool
}
```

Compile-time interface verification:
```go
var _ backend.Backend = (*Backend)(nil)
var _ backend.Writer  = (*Backend)(nil)
```

Implement `New(client Client) *Backend` — creates backend with client, no initial sync (caller triggers first sync).

**Backend interface (read operations):**

- `ListServers(ctx context.Context)` — scan ALL accessible vaults via `client.ListVaults()`, for each vault list items via `client.ListItems()`, filter by `HasSshjesusTag()`, convert via `ItemToServer()`. Cache results in `b.servers`. Return copies (copy-on-read per project convention). Log and skip vaults/items with errors (don't fail entire list).
- `GetServer(ctx context.Context, id string)` — linear search through cached servers (small lists). Return copy or ErrServerNotFound.
- `ListProjects(ctx context.Context)` — return empty slice (projects are tags on items, not standalone 1P entities).
- `GetProject(ctx context.Context, id string)` — return ErrProjectNotFound.
- `ListCredentials(ctx context.Context)` / `GetCredential(ctx context.Context, id string)` — return empty slice / ErrCredentialNotFound (credentials are embedded in items).
- `Close()` — close SDK client, mark as closed.

**Writer interface (write operations):**

- `CreateServer(ctx context.Context, server *domain.Server)` — convert to item via `ServerToItem()`, use server.VaultID as target vault (error if empty — caller must set VaultID), create via `client.CreateItem()`. Update cache.
- `UpdateServer(ctx context.Context, server *domain.Server)` — get existing item first (`client.GetItem()`), update fields from server, call `client.UpdateItem()`. Update cache.
- `DeleteServer(ctx context.Context, id string)` — find server in cache to get VaultID, call `client.DeleteItem()`. Remove from cache.
- `CreateProject/UpdateProject/DeleteProject` — return `errors.ErrReadOnlyBackend` (projects are tags, not standalone entities).
- `CreateCredential/UpdateCredential/DeleteCredential` — return `errors.ErrReadOnlyBackend`.

**TDD tests** (`backend_test.go`):
- Use MockClient from Task 1
- RED: `TestListServers` — mock client with 2 vaults, 3 items (2 tagged "sshjesus", 1 not) -> returns exactly 2 servers
- RED: `TestListServersSkipsErrorVaults` — one vault errors on list -> returns servers from other vaults
- RED: `TestGetServerFound` / `TestGetServerNotFound`
- RED: `TestCreateServer` — creates item in correct vault, appears in subsequent ListServers
- RED: `TestUpdateServer` — modifies item fields
- RED: `TestDeleteServer` — removes from 1Password and cache
- RED: `TestClosedBackendReturnsError` — all operations on closed backend return ErrBackendUnavailable
- GREEN: Implement to pass
- REFACTOR: Clean up

Use `errors.BackendError` with Backend="onepassword" for all error wrapping (consistent with sshconfig pattern).
  </action>
  <verify>
Run `go test ./internal/backend/onepassword/... -v` — all tests pass.
Run `go vet ./internal/backend/onepassword/...` — no issues.
Verify interface compliance: `grep "var _ backend" internal/backend/onepassword/backend.go` shows both Backend and Writer.
  </verify>
  <done>
1Password backend implements Backend and Writer interfaces. Tag-based discovery correctly filters items across vaults. CRUD operations work through SDK client. All tests pass with mock client. Error handling follows project conventions (BackendError wrapping).
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/backend/onepassword/... -v -count=1` — all tests pass
2. `go build ./...` — entire project compiles
3. `go vet ./...` — no vet warnings
4. `grep "var _ backend.Backend" internal/backend/onepassword/backend.go` — interface compliance
5. `grep "var _ backend.Writer" internal/backend/onepassword/backend.go` — writer compliance
6. `grep "RemoteProjectPath" internal/domain/server.go` — domain extension present
</verification>

<success_criteria>
- 1Password backend passes all unit tests with mock client
- Item mapping is bidirectional and lossless (round-trip test)
- Backend correctly implements both Backend and Writer interfaces
- Tag-based discovery filters correctly (case-insensitive)
- domain.Server has RemoteProjectPath and VaultID fields
- Error wrapping uses BackendError with "onepassword" backend identifier
</success_criteria>

<output>
After completion, create `.planning/phases/06-1password-backend/06-01-SUMMARY.md`
</output>
