---
phase: 06-1password-backend
plan: 02
type: tdd
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/sync/ssh_include.go
  - internal/sync/ssh_include_test.go
  - internal/sync/toml_cache.go
  - internal/sync/toml_cache_test.go
  - internal/sync/conflict.go
  - internal/sync/conflict_test.go
autonomous: true

must_haves:
  truths:
    - "1Password servers sync to ~/.ssh/sshjesus_config as valid SSH Host blocks"
    - "Include directive is prepended to ~/.ssh/config if not already present"
    - "Local TOML cache stores sshjesus-specific fields (RemoteProjectPath, project tags)"
    - "Conflicts detected when same alias exists in both 1Password and user SSH config"
    - "1Password always wins conflicts per requirement"
  artifacts:
    - path: "internal/sync/ssh_include.go"
      provides: "Write SSH include file and ensure Include directive"
      exports: ["WriteSSHIncludeFile", "EnsureIncludeDirective"]
    - path: "internal/sync/toml_cache.go"
      provides: "Write local TOML cache with sshjesus-specific fields"
      exports: ["WriteTOMLCache", "ReadTOMLCache"]
    - path: "internal/sync/conflict.go"
      provides: "Conflict detection between 1Password and SSH config"
      exports: ["DetectConflicts", "Conflict"]
  key_links:
    - from: "internal/sync/ssh_include.go"
      to: "internal/domain/server.go"
      via: "converts domain.Server to SSH Host blocks"
      pattern: "domain\\.Server"
    - from: "internal/sync/toml_cache.go"
      to: "internal/domain/server.go"
      via: "serializes domain.Server with sshjesus-specific fields"
      pattern: "domain\\.Server"
    - from: "internal/sync/conflict.go"
      to: "internal/sshconfig/parser.go"
      via: "parses user SSH config to detect duplicate aliases"
      pattern: "sshconfig\\.ParseSSHConfig"
---

<objective>
Implement the sync engine that writes 1Password servers to local storage: SSH include file (~/.ssh/sshjesus_config), TOML cache (sshjesus-specific fields), Include directive management, and conflict detection.

Purpose: Local sync enables standard SSH commands to work with 1Password servers (`ssh prod-web-01`) and provides offline fallback data. Conflict detection prevents confusion when same server exists in both backends.

Output: Sync package with tested functions for SSH include file generation, TOML cache management, Include directive setup, and conflict detection.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-1password-backend/06-RESEARCH.md
@.planning/phases/06-1password-backend/06-01-SUMMARY.md
@internal/domain/server.go
@internal/sshconfig/parser.go
@internal/sshconfig/writer.go
@internal/sshconfig/backup.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: SSH include file writer and Include directive management</name>
  <files>
    internal/sync/ssh_include.go
    internal/sync/ssh_include_test.go
  </files>
  <action>
**Create `internal/sync/ssh_include.go`:**

`WriteSSHIncludeFile(servers []*domain.Server, includePath string) error`:
- Generate valid SSH config content from servers:
  - Header comment: `# Generated by sshjesus - DO NOT EDIT MANUALLY\n# Source: 1Password\n# Last sync: {timestamp}\n`
  - For each server, write a Host block:
    - `Host {DisplayName}` (DisplayName is the alias)
    - `    HostName {Host}`
    - `    User {User}`
    - `    Port {Port}` (only if != 22)
    - `    IdentityFile {IdentityFile}` (only if non-empty)
    - `    ProxyJump {Proxy}` (only if non-empty)
    - `    ForwardAgent yes` (only if server has ForwardAgent flag — check Notes or Tags for this; use a convention)
  - Blank line between blocks
- Use `renameio.WriteFile(includePath, content, 0600)` for atomic write (already a project dependency)
- Default includePath: `~/.ssh/sshjesus_config` (caller can override for testing)

`EnsureIncludeDirective(sshConfigPath, includePath string) error`:
- Read `~/.ssh/config` (create if doesn't exist with 0600 perms)
- Check if `Include {includePath}` already exists (case-insensitive match)
- If not found, prepend to top of file:
  ```
  # sshjesus 1Password integration
  Include {includePath}

  {existing content}
  ```
- Use atomic write (renameio) — this is modifying user's SSH config, must be safe
- CRITICAL: Prepend (not append) because SSH config is first-match-wins. If `Host *` appears before Include, 1Password servers won't match.

**TDD tests** (`ssh_include_test.go`):
- Use temp directories for all tests (never touch real ~/.ssh)
- RED: `TestWriteSSHIncludeFile_FullServer` — server with all fields -> correct Host block
- RED: `TestWriteSSHIncludeFile_MinimalServer` — only hostname+user+port22 -> no Port line
- RED: `TestWriteSSHIncludeFile_MultipleServers` — 3 servers -> 3 blocks with blank separators
- RED: `TestWriteSSHIncludeFile_EmptyServers` — empty slice -> header only
- RED: `TestWriteSSHIncludeFile_Permissions` — output file has 0600 permissions
- RED: `TestEnsureIncludeDirective_NewFile` — creates config with Include line
- RED: `TestEnsureIncludeDirective_ExistingWithoutInclude` — prepends Include to existing content
- RED: `TestEnsureIncludeDirective_AlreadyPresent` — no-op if Include exists
- RED: `TestEnsureIncludeDirective_Idempotent` — calling twice doesn't add duplicate
- GREEN: Implement to pass
- REFACTOR: Extract host block builder if code gets complex
  </action>
  <verify>
Run `go test ./internal/sync/... -v -run TestWrite` — all write tests pass.
Run `go test ./internal/sync/... -v -run TestEnsure` — all include directive tests pass.
  </verify>
  <done>
SSH include file writer generates valid SSH config from domain.Server list. Include directive is prepended safely to ~/.ssh/config. All operations use atomic writes. Tests cover full/minimal servers, permissions, and idempotent behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: TOML cache writer/reader and conflict detection</name>
  <files>
    internal/sync/toml_cache.go
    internal/sync/toml_cache_test.go
    internal/sync/conflict.go
    internal/sync/conflict_test.go
  </files>
  <action>
**Create `internal/sync/toml_cache.go`:**

TOML cache stores sshjesus-specific fields that don't fit in SSH config (RemoteProjectPath, ProjectIDs/tags, VaultID, last sync time).

Define TOML-serializable structs:
```go
type CachedServer struct {
    ID                string   `toml:"id"`
    DisplayName       string   `toml:"display_name"`
    Host              string   `toml:"host"`
    User              string   `toml:"user"`
    Port              int      `toml:"port"`
    IdentityFile      string   `toml:"identity_file,omitempty"`
    Proxy             string   `toml:"proxy,omitempty"`
    RemoteProjectPath string   `toml:"remote_project_path,omitempty"`
    ProjectIDs        []string `toml:"project_ids,omitempty"`
    VaultID           string   `toml:"vault_id"`
    Tags              []string `toml:"tags,omitempty"`
}

type TOMLCache struct {
    LastSync time.Time      `toml:"last_sync"`
    Servers  []CachedServer `toml:"server"`
}
```

Implement:
- `WriteTOMLCache(servers []*domain.Server, cachePath string) error` — convert domain.Server list to CachedServer list, encode as TOML, atomic write via renameio. Default cachePath: XDG config dir + `sshjesus/1password_cache.toml`
- `ReadTOMLCache(cachePath string) ([]*domain.Server, error)` — decode TOML, convert CachedServer list back to domain.Server list. Used for offline fallback.

**Create `internal/sync/conflict.go`:**

```go
type Conflict struct {
    Alias        string          // The SSH host alias
    OnePassword  *domain.Server  // Server from 1Password
    SSHConfig    *domain.Server  // Server from user's SSH config
    Winner       string          // Always "onepassword" per requirement
}
```

`DetectConflicts(onePasswordServers []*domain.Server, sshConfigPath string) ([]Conflict, error)`:
- Parse user's SSH config using `sshconfig.ParseSSHConfig(sshConfigPath)`
- Build a map of SSH config host names (EXCLUDING hosts from the sshjesus_config include file — check by comparing source file paths, or by checking if DisplayName starts with known 1P servers)
- Actually, simpler approach: parse the main SSH config directly (not via Include resolution). The include file is separate. If the SSH config parser follows Includes, we need to filter out entries from the sshjesus_config file. Use `SourceFile` field on SSHHost to filter.
- For each 1Password server, check if its DisplayName matches any SSH config host name (case-insensitive)
- Create Conflict entry with Winner="onepassword"

**TDD tests:**

For TOML cache (`toml_cache_test.go`):
- RED: `TestWriteReadTOMLCache_RoundTrip` — write servers, read back, compare
- RED: `TestReadTOMLCache_NotFound` — returns error for non-existent file
- RED: `TestWriteTOMLCache_PreservesRemoteProjectPath` — sshjesus-specific field survives round-trip
- GREEN: Implement to pass

For conflict detection (`conflict_test.go`):
- RED: `TestDetectConflicts_NoConflicts` — 1P servers have different names than SSH config -> empty
- RED: `TestDetectConflicts_OneConflict` — 1P server "prod-web" also in SSH config -> one conflict with Winner="onepassword"
- RED: `TestDetectConflicts_CaseInsensitive` — "Prod-Web" in 1P, "prod-web" in SSH -> conflict detected
- RED: `TestDetectConflicts_ExcludesSshjesusConfig` — entries from sshjesus_config include file are NOT conflicts
- GREEN: Implement to pass
  </action>
  <verify>
Run `go test ./internal/sync/... -v` — all tests pass.
Run `go vet ./internal/sync/...` — no issues.
  </verify>
  <done>
TOML cache supports write/read round-trips preserving sshjesus-specific fields. Conflict detection finds duplicate aliases between 1Password and SSH config (excluding sshjesus include file entries). All sync components tested with temp files.
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/sync/... -v -count=1` — all tests pass
2. `go build ./...` — entire project compiles
3. `go vet ./internal/sync/...` — no vet warnings
4. Generated SSH include file is valid SSH config (parseable by `sshconfig.ParseSSHConfig`)
5. TOML cache round-trip preserves all fields
6. Conflict detection excludes sshjesus include file entries
</verification>

<success_criteria>
- SSH include file contains valid Host blocks for all 1Password servers
- Include directive prepended to ~/.ssh/config (not appended)
- TOML cache preserves RemoteProjectPath and ProjectIDs through round-trip
- Conflicts detected by alias name (case-insensitive), 1Password always wins
- All file operations use atomic writes (renameio)
- Tests use temp directories, never touch real SSH config
</success_criteria>

<output>
After completion, create `.planning/phases/06-1password-backend/06-02-SUMMARY.md`
</output>
