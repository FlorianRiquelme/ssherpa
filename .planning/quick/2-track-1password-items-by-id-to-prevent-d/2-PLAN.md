---
phase: quick-2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/backend/multi.go
  - internal/backend/multi_test.go
autonomous: true

must_haves:
  truths:
    - "Renaming a 1Password item does not produce duplicates in the server list"
    - "Servers from ssherpa_config include file are filtered out when 1Password backend is active"
    - "Pure SSH config servers (not from ssherpa_config) are still shown and deduped by DisplayName"
    - "Existing priority-based dedup (later backend wins) still works for DisplayName conflicts"
  artifacts:
    - path: "internal/backend/multi.go"
      provides: "Updated ListServers with ssherpa-generated server filtering"
      contains: "ssherpa_config"
    - path: "internal/backend/multi_test.go"
      provides: "Tests for ID-based dedup and ssherpa-generated filtering"
      contains: "TestMultiBackend_FiltersOutSsherpaGeneratedServers"
  key_links:
    - from: "internal/backend/multi.go"
      to: "internal/domain/server.go"
      via: "Server.Source and Server.Notes fields"
      pattern: "server\\.Source.*server\\.Notes"
---

<objective>
Fix duplicate server entries when a 1Password item is renamed or updated.

Purpose: Currently MultiBackend.ListServers() deduplicates by DisplayName only. When a user renames a 1Password item, the stale entry in ~/.ssh/ssherpa_config (auto-generated SSH include file) still has the old name, while 1Password returns the new name. Since DisplayName differs, both appear as separate servers.

Output: Updated MultiBackend that filters out ssherpa-generated SSH config entries (which are always mirrors of 1Password data) before dedup, preventing phantom duplicates when items are renamed.
</objective>

<execution_context>
@/Users/florianriquelme/.claude/get-shit-done/workflows/execute-plan.md
@/Users/florianriquelme/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@internal/backend/multi.go
@internal/backend/multi_test.go
@internal/domain/server.go
@internal/sshconfig/backend.go
@internal/sync/conflict.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter ssherpa-generated servers and add ID-aware dedup in MultiBackend</name>
  <files>internal/backend/multi.go</files>
  <action>
Modify `MultiBackend.ListServers()` to fix the duplicate-on-rename bug. The root cause: servers from `~/.ssh/ssherpa_config` (auto-generated by ssherpa from 1Password data) are read back by the SSH config backend, creating mirror entries. When 1Password items get renamed, these mirrors become stale and don't match by DisplayName anymore.

Two changes to the dedup logic in `ListServers()`:

1. **Filter out ssherpa-generated mirrors**: After collecting servers from all backends, remove any server where `Source == "ssh-config"` AND `Notes` contains `"ssherpa_config"`. These are always redundant copies of 1Password data. The authoritative version comes from the 1Password backend directly. This mirrors the same detection pattern already used in `sync/conflict.go` (`isSshjesusGenerated`).

   Add a helper function `isSsherpaGenerated(server *domain.Server) bool` that checks:
   - `server.Source == "ssh-config"` (from SSH config backend)
   - `strings.Contains(server.Notes, "ssherpa_config")` (from the auto-generated include file)

2. **Keep existing DisplayName dedup intact**: After filtering, the remaining servers are either pure SSH config entries (user-authored) or 1Password entries. The existing case-insensitive DisplayName dedup handles conflicts between these correctly (1Password wins as higher priority backend).

The filtering step goes BEFORE the existing dedup map logic. Pseudocode:
```go
// Step 1: Collect from all backends (existing code)
// Step 2: Filter out ssherpa-generated mirrors
filtered := make([]*domain.Server, 0, len(allServers))
for _, server := range allServers {
    if !isSsherpaGenerated(server) {
        filtered = append(filtered, server)
    }
}
// Step 3: Deduplicate by DisplayName (existing code, on filtered list)
```

Add `"strings"` import if not already present (it is already imported).
  </action>
  <verify>`cd /Users/florianriquelme/Repos/mine/sshjesus && go build ./...` compiles without errors</verify>
  <done>MultiBackend.ListServers filters out ssherpa-generated SSH config mirrors before DisplayName dedup. isSsherpaGenerated helper exists.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for ssherpa-generated server filtering and rename dedup</name>
  <files>internal/backend/multi_test.go</files>
  <action>
Add three test cases to `multi_test.go`:

1. **`TestMultiBackend_FiltersOutSsherpaGeneratedServers`**:
   - Backend A (ssh-config) has two servers:
     - `{ID: "my-server", DisplayName: "my-server", Host: "1.2.3.4", Source: "ssh-config", Notes: "Source: /home/user/.ssh/ssherpa_config:5"}` (ssherpa-generated mirror)
     - `{ID: "manual-host", DisplayName: "manual-host", Host: "5.6.7.8", Source: "ssh-config", Notes: "Source: /home/user/.ssh/config:10"}` (user-authored)
   - Backend B (1password) has one server:
     - `{ID: "op-abc123", DisplayName: "my-server", Host: "1.2.3.4", Source: "1password"}`
   - Expected: ListServers returns 2 servers (not 3). "manual-host" from SSH config and "my-server" from 1Password. The ssherpa_config mirror is filtered out.

2. **`TestMultiBackend_RenamedOnePasswordItemNoDuplicate`**:
   - Backend A (ssh-config) has:
     - `{ID: "old-name", DisplayName: "old-name", Host: "1.2.3.4", Source: "ssh-config", Notes: "Source: /home/user/.ssh/ssherpa_config:5"}` (stale mirror with OLD name)
   - Backend B (1password) has:
     - `{ID: "op-abc123", DisplayName: "new-name", Host: "1.2.3.4", Source: "1password"}` (renamed)
   - Expected: ListServers returns 1 server with DisplayName="new-name" from 1Password. The stale "old-name" mirror is filtered out.
   - This is the exact bug scenario described in the issue.

3. **`TestMultiBackend_PureSshConfigServersNotFiltered`**:
   - Backend A (ssh-config) has:
     - `{ID: "user-host", DisplayName: "user-host", Host: "9.8.7.6", Source: "ssh-config", Notes: "Source: /home/user/.ssh/config:3"}` (user-authored, NOT from ssherpa_config)
   - Backend B (1password) has no servers (empty)
   - Expected: ListServers returns 1 server. User-authored SSH config entries are never filtered.

All tests use `mock.New()` and `backendA.Seed(...)` pattern consistent with existing tests. Use `require` and `assert` from testify.
  </action>
  <verify>`cd /Users/florianriquelme/Repos/mine/sshjesus && go test ./internal/backend/ -v -run "TestMultiBackend_Filter|TestMultiBackend_Renamed|TestMultiBackend_PureSsh"` â€” all 3 new tests pass</verify>
  <done>Three new tests pass covering: ssherpa-generated filtering, renamed item no-duplicate, and pure SSH config preservation. All existing tests still pass (`go test ./internal/backend/ -v`).</done>
</task>

</tasks>

<verification>
```bash
# All backend tests pass (new + existing)
cd /Users/florianriquelme/Repos/mine/sshjesus && go test ./internal/backend/ -v

# Full project builds
cd /Users/florianriquelme/Repos/mine/sshjesus && go build ./...

# All project tests pass (no regressions)
cd /Users/florianriquelme/Repos/mine/sshjesus && go test ./...
```
</verification>

<success_criteria>
- Renamed 1Password items produce exactly 1 server entry (not 2)
- Servers from ssherpa_config include file are filtered out before dedup
- User-authored SSH config entries are preserved
- Existing DisplayName-based dedup still works for non-ssherpa conflicts
- All existing tests pass without modification
- 3 new tests validate the fix
</success_criteria>

<output>
After completion, create `.planning/quick/2-track-1password-items-by-id-to-prevent-d/2-SUMMARY.md`
</output>
